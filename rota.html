<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Servi√ßo</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f5;
        }
        #reader {
            width: 100%;
            max-width: 400px;
            margin: auto;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px solid #a3b2b4;
            display: none;
        }
        .message-box {
            padding: 1rem;
            background-color: #d1e7e4;
            border-radius: 0.75rem;
            border: 1px solid #b7d6d1;
            margin-top: 1rem;
            display: none;
        }
        .data-display {
            background-color: #e6f0f2;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #c8d8e0;
            margin-top: 1.5rem;
        }
        .data-display div {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #a3b2b4;
        }
        .data-display div:last-child {
            border-bottom: none;
        }
        .button-primary {
            @apply bg-[#1a4a44] text-white shadow-md hover:bg-[#123631] transition-colors;
        }
        .button-secondary {
            @apply bg-[#a3b2b4] text-gray-800 shadow-sm hover:bg-[#8e9c9f] transition-colors;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">

    <!-- Login Container - Visible by default -->
    <div id="login-container" class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Login de Funcion√°rio</h1>

        <!-- Login Form -->
        <div class="space-y-4">
            <div>
                <label for="company-select" class="block text-sm font-medium text-gray-700 mb-1">Empresa Terceirizada</label>
                <select id="company-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <option value="" disabled selected>Selecione a empresa</option>
                </select>
            </div>
            <div>
                <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-1">Nome do Funcion√°rio</label>
                <select id="employee-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow" disabled>
                    <option value="" disabled selected>Selecione um funcion√°rio</option>
                </select>
            </div>
            <div>
                <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input type="password" id="password-input" placeholder="Digite sua senha" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <button id="login-btn" class="w-full py-3 rounded-lg font-semibold text-lg button-primary">
                Entrar
            </button>
        </div>
        
        <div id="login-message-box" class="message-box" style="display:none;">
            <p id="login-message-text" class="text-sm font-medium text-gray-700"></p>
        </div>

    </div>

    <!-- Main App Container - Hidden until login -->
    <div id="app-container" class="bg-[#d1e7e4] rounded-xl shadow-lg p-6 max-w-sm w-full" style="display:none;">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Registro de Servi√ßo</h1>
        
        <!-- User authentication will be handled by Power Apps -->
        <p class="text-center text-gray-600 mb-4">Bem-vindo(a), <span id="logged-in-user"></span>!</p>

        <!-- Service Order Number Input -->
        <div class="mb-4">
            <label for="os-number" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero da Ordem de Servi√ßo</label>
            <input type="text" id="os-number" placeholder="Digite a O.S." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
        </div>

        <!-- Barcode Scanner View -->
        <div id="reader"></div>

        <!-- Buttons for Service Start/End -->
        <div id="action-buttons" class="flex flex-col space-y-3">
            <button id="start-scan-btn" class="w-full py-3 rounded-lg font-semibold text-lg button-primary">
                Escanear para Iniciar
            </button>
            <button id="finish-scan-btn" class="w-full py-3 rounded-lg font-semibold text-lg button-primary" style="display:none;">
                Escanear para Finalizar
            </button>
            <button id="generate-summary-btn" class="w-full py-3 rounded-lg font-semibold text-lg button-secondary" style="display:none;">
                Gerar Resumo do Servi√ßo ‚ú®
            </button>
        </div>

        <!-- Field for Technician's Observations -->
        <div id="observations-input-container" class="mt-4 hidden">
            <label for="observations-text" class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes do T√©cnico</label>
            <textarea id="observations-text" placeholder="Descreva o servi√ßo realizado, pend√™ncias, etc." rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow"></textarea>
        </div>

        <!-- Field for Photo Capture -->
        <div id="photo-input-container" class="mt-4 hidden">
             <input type="file" id="photo-file-input" accept="image/*" capture="camera" class="hidden">
             <button id="take-photo-btn" class="w-full py-3 rounded-lg font-semibold text-lg button-secondary mt-3">
                Tirar Foto üì∏
            </button>
        </div>

        <!-- Message Box for User Feedback -->
        <div id="message-box" class="message-box" style="display:none;">
            <p id="message-text" class="text-sm font-medium text-gray-700"></p>
        </div>

        <!-- Data Display Section -->
        <div id="data-display" class="data-display hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Dados do Servi√ßo</h2>
            <div id="os-display" class="hidden">
                <span class="font-semibold text-gray-600">O.S.:</span> <span id="os-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="start-data-display" class="hidden">
                <span class="font-semibold text-gray-600">In√≠cio:</span> <span id="start-datetime-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="end-data-display" class="hidden">
                <span class="font-semibold text-gray-600">Fim:</span> <span id="end-datetime-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="start-location-display" class="hidden">
                <span class="font-semibold text-gray-600">Localiza√ß√£o (In√≠cio):</span> <span id="start-location-text" class="font-medium text-gray-800"></span>
            </div>
             <div id="end-location-display" class="hidden">
                <span class="font-semibold text-gray-600">Localiza√ß√£o (Fim):</span> <span id="end-location-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="distance-display" class="hidden">
                <span class="font-semibold text-gray-600">Dist√¢ncia Percorrida:</span> <span id="distance-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="barcode-display" class="hidden">
                <span class="font-semibold text-gray-600">C√≥d. de Barras:</span> <span id="barcode-text" class="font-medium text-gray-800"></span>
            </div>
             <div id="equipment-type-display" class="hidden">
                <span class="font-semibold text-gray-600">Tipo de Equipamento:</span> <span id="equipment-type-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="inventory-display" class="hidden">
                <span class="font-semibold text-gray-600">Invent√°rio:</span> <span id="inventory-text" class="font-medium text-gray-800"></span>
            </div>
             <div id="observations-display" class="hidden">
                <span class="font-semibold text-gray-600">Observa√ß√µes:</span> <span id="observations-text-display" class="font-medium text-gray-800 whitespace-pre-wrap"></span>
            </div>
             <div id="photo-display" class="hidden">
                <span class="font-semibold text-gray-600">Foto:</span>
                <img id="photo-preview" src="" alt="Pr√©via da foto tirada" class="rounded-lg mt-2 w-full h-auto max-w-sm">
            </div>
        </div>
        
        <!-- Summary Container -->
        <div id="summary-container" class="data-display hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Resumo do Servi√ßo (IA)</h2>
            <p id="summary-text" class="text-gray-700 text-sm italic"></p>
        </div>

        <!-- Save Button -->
        <button id="save-data-btn" class="w-full py-3 rounded-lg font-bold text-lg button-primary mt-6 hidden">
            Salvar no SharePoint
        </button>

    </div>

    <!-- Html5-QR-Code Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // Main application state and data container
        const appState = {
            osNumber: '',
            barcodeData: '',
            equipmentType: '',
            inventoryNumber: '',
            observations: '',
            photoData: '', // New: Field for photo data in Base64 format
            start: {
                timestamp: null,
                location: null,
            },
            end: {
                timestamp: null,
                location: null,
            },
            scanMode: 'start', // 'start' or 'end'
        };

        // Mock data for login (would be from SharePoint in the real app)
        const loginData = {
            "Arcondi": {
                "Abc": "123",
                "Def": "123",
                "Ghi": "123"
            },
            "Lubrica": {
                "Jk": "123",
                "Lm": "123",
                "No": "123"
            }
        };

        // DOM element references
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const companySelect = document.getElementById('company-select');
        const employeeSelect = document.getElementById('employee-select');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const loginMessageBox = document.getElementById('login-message-box');
        const loginMessageText = document.getElementById('login-message-text');
        const loggedInUserText = document.getElementById('logged-in-user');

        const osInput = document.getElementById('os-number');
        const startScanBtn = document.getElementById('start-scan-btn');
        const finishScanBtn = document.getElementById('finish-scan-btn');
        const generateSummaryBtn = document.getElementById('generate-summary-btn');
        const saveDataBtn = document.getElementById('save-data-btn');
        const readerDiv = document.getElementById('reader');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const dataDisplay = document.getElementById('data-display');
        const osDisplay = document.getElementById('os-display');
        const osText = document.getElementById('os-text');
        const startDataDisplay = document.getElementById('start-data-display');
        const startDatetimeText = document.getElementById('start-datetime-text');
        const endDataDisplay = document.getElementById('end-data-display');
        const endDatetimeText = document.getElementById('end-datetime-text');
        const startLocationDisplay = document.getElementById('start-location-display');
        const startLocationText = document.getElementById('start-location-text');
        const endLocationDisplay = document.getElementById('end-location-display');
        const endLocationText = document.getElementById('end-location-text');
        const distanceDisplay = document.getElementById('distance-display');
        const distanceText = document.getElementById('distance-text');
        const barcodeDisplay = document.getElementById('barcode-display');
        const barcodeText = document.getElementById('barcode-text');
        const equipmentTypeDisplay = document.getElementById('equipment-type-display');
        const equipmentTypeText = document.getElementById('equipment-type-text');
        const inventoryDisplay = document.getElementById('inventory-display');
        const inventoryText = document.getElementById('inventory-text');
        const observationsInputContainer = document.getElementById('observations-input-container');
        const observationsTextArea = document.getElementById('observations-text');
        const observationsDisplay = document.getElementById('observations-display');
        const observationsTextDisplay = document.getElementById('observations-text-display');
        const photoInputContainer = document.getElementById('photo-input-container');
        const takePhotoButton = document.getElementById('take-photo-btn');
        const photoFileInput = document.getElementById('photo-file-input');
        const photoDisplay = document.getElementById('photo-display');
        const photoPreview = document.getElementById('photo-preview');
        const summaryContainer = document.getElementById('summary-container');
        const summaryText = document.getElementById('summary-text');
        
        let html5QrCode;

        // Helper function to show a temporary message
        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.style.display = 'block';
            if (isError) {
                messageBox.classList.remove('bg-gray-200');
                messageBox.classList.add('bg-red-200');
            } else {
                messageBox.classList.remove('bg-gray-200');
                messageBox.classList.add('bg-gray-200');
            }
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        function showLoginMessage(text, isError = false) {
            loginMessageText.textContent = text;
            loginMessageBox.style.display = 'block';
            if (isError) {
                loginMessageBox.classList.remove('bg-gray-200');
                loginMessageBox.classList.add('bg-red-200');
            } else {
                loginMessageBox.classList.remove('bg-gray-200');
                loginMessageBox.classList.add('bg-gray-200');
            }
            setTimeout(() => {
                loginMessageBox.style.display = 'none';
            }, 5000);
        }

        // Initialize login dropdowns
        function setupLoginDropdowns() {
            // Populate company dropdown
            for (const company in loginData) {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            }

            // Listen for company selection change
            companySelect.addEventListener('change', () => {
                const selectedCompany = companySelect.value;
                employeeSelect.innerHTML = '<option value="" disabled selected>Selecione um funcion√°rio</option>';
                employeeSelect.disabled = false;
                if (selectedCompany && loginData[selectedCompany]) {
                    for (const employee in loginData[selectedCompany]) {
                        const option = document.createElement('option');
                        option.value = employee;
                        option.textContent = employee;
                        employeeSelect.appendChild(option);
                    }
                }
            });
        }
        
        // Handle login attempt
        loginBtn.addEventListener('click', () => {
            const company = companySelect.value;
            const employee = employeeSelect.value;
            const password = passwordInput.value;

            if (!company || !employee || !password) {
                showLoginMessage("Por favor, preencha todos os campos.", true);
                return;
            }

            if (loginData[company] && loginData[company][employee] === password) {
                showLoginMessage("Login bem-sucedido!");
                loggedInUserText.textContent = employee;
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
            } else {
                showLoginMessage("Usu√°rio ou senha incorretos.", true);
            }
        });

        // Function to start the camera scanner
        async function startScanner() {
            try {
                // Ensure the reader div is visible
                readerDiv.style.display = 'block';
                startScanBtn.style.display = 'none';
                finishScanBtn.style.display = 'none';
                generateSummaryBtn.style.display = 'none';
                observationsInputContainer.classList.add('hidden');
                photoInputContainer.classList.add('hidden');

                // Request camera permission with facingMode set to 'environment'
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    formatsToSupport: [Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.QR_CODE],
                };
                const constraints = {
                    facingMode: { exact: "environment" }
                };

                html5QrCode = new Html5Qrcode("reader");

                await html5QrCode.start(
                    constraints,
                    config,
                    (decodedText, decodedResult) => {
                        // On successful scan
                        html5QrCode.stop().then(() => {
                            readerDiv.style.display = 'none';
                            if (appState.scanMode === 'start') {
                                handleStartScanSuccess(decodedText);
                            } else {
                                handleFinishScanSuccess();
                            }
                        }).catch(err => {
                            console.error("Error stopping scanner:", err);
                        });
                    },
                    (errorMessage) => {
                        // Ignore continuous error messages
                    }
                );
            } catch (err) {
                console.error("Erro ao iniciar o scanner:", err);
                showMessage(`Erro ao iniciar a c√¢mera. Verifique as permiss√µes. Erro: ${err.message}`, true);
                readerDiv.style.display = 'none';
                startScanBtn.style.display = 'block';
            }
        }
        
        function handleStartScanSuccess(decodedText) {
            showMessage("C√≥digo de barras escaneado com sucesso!");
            
            // Extracting equipment type and inventory number
            const equipmentType = decodedText.charAt(0).toUpperCase();
            const inventoryNumber = decodedText.substring(1);

            appState.barcodeData = decodedText;
            appState.equipmentType = equipmentType;
            appState.inventoryNumber = inventoryNumber;

            barcodeText.textContent = decodedText;
            equipmentTypeText.textContent = equipmentType;
            inventoryText.textContent = inventoryNumber;

            barcodeDisplay.classList.remove('hidden');
            equipmentTypeDisplay.classList.remove('hidden');
            inventoryDisplay.classList.remove('hidden');

            // Capture start timestamp
            appState.start.timestamp = new Date();
            startDatetimeText.textContent = appState.start.timestamp.toLocaleString('pt-BR');
            startDataDisplay.classList.remove('hidden');

            // Get start location
            if (navigator.geolocation) {
                showMessage("Obtendo sua localiza√ß√£o de in√≠cio...");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = position.coords;
                        appState.start.location = {
                            latitude: coords.latitude,
                            longitude: coords.longitude,
                            accuracy: coords.accuracy,
                        };
                        startLocationText.textContent = `Lat: ${coords.latitude.toFixed(4)}, Long: ${coords.longitude.toFixed(4)}`;
                        startLocationDisplay.classList.remove('hidden');
                        showMessage("Localiza√ß√£o de in√≠cio obtida com sucesso!");
                    },
                    (error) => {
                        showMessage("N√£o foi poss√≠vel obter a localiza√ß√£o de in√≠cio. Verifique as permiss√µes do seu navegador.", true);
                        console.error("Geolocation error:", error);
                        startLocationText.textContent = "Erro ao obter localiza√ß√£o";
                        startLocationDisplay.classList.remove('hidden');
                    }
                );
            } else {
                showMessage("Seu navegador n√£o suporta geolocaliza√ß√£o.", true);
                startLocationText.textContent = "Geolocaliza√ß√£o n√£o suportada";
                startLocationDisplay.classList.remove('hidden');
            }
            
            // Show data and switch button
            dataDisplay.classList.remove('hidden');
            finishScanBtn.style.display = 'block';
            generateSummaryBtn.style.display = 'block';
            saveDataBtn.classList.remove('hidden');
            observationsInputContainer.classList.remove('hidden');
            photoInputContainer.classList.remove('hidden');
        }

        function handleFinishScanSuccess() {
            showMessage("Fim do servi√ßo registrado!");
            // Capture end timestamp
            appState.end.timestamp = new Date();
            endDatetimeText.textContent = appState.end.timestamp.toLocaleString('pt-BR');
            endDataDisplay.classList.remove('hidden');

            // Get end location
            if (navigator.geolocation) {
                showMessage("Obtendo sua localiza√ß√£o de encerramento...");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = position.coords;
                        appState.end.location = {
                            latitude: coords.latitude,
                            longitude: coords.longitude,
                            accuracy: coords.accuracy,
                        };
                        endLocationText.textContent = `Lat: ${coords.latitude.toFixed(4)}, Long: ${coords.longitude.toFixed(4)}`;
                        endLocationDisplay.classList.remove('hidden');
                        showMessage("Localiza√ß√£o de encerramento obtida com sucesso!");
                    },
                    (error) => {
                        showMessage("N√£o foi poss√≠vel obter a localiza√ß√£o de encerramento. Verifique as permiss√µes do seu navegador.", true);
                        console.error("Geolocation error:", error);
                        endLocationText.textContent = "Erro ao obter localiza√ß√£o";
                        endLocationDisplay.classList.remove('hidden');
                    }
                );
            } else {
                showMessage("Seu navegador n√£o suporta geolocaliza√ß√£o.", true);
                endLocationText.textContent = "Geolocaliza√ß√£o n√£o suportada";
                endLocationDisplay.classList.remove('hidden');
            }

            finishScanBtn.style.display = 'none';
            saveDataBtn.classList.remove('hidden');
        }

        // --- Gemini API Integration ---
        // Constants for the Gemini API call
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Event listener for the new "Gerar Resumo" button
        generateSummaryBtn.addEventListener('click', async () => {
            if (!appState.osNumber || !appState.equipmentType) {
                showMessage("Por favor, preencha a O.S. e escaneie o c√≥digo de barras primeiro.", true);
                return;
            }

            showMessage("Gerando resumo com IA...", false);
            summaryContainer.classList.add('hidden');
            summaryText.textContent = '';
            generateSummaryBtn.disabled = true;

            const userPrompt = `Aja como um t√©cnico experiente. Crie um resumo de um relat√≥rio de servi√ßo t√©cnico para um equipamento. O n√∫mero da Ordem de Servi√ßo √© ${appState.osNumber} e o tipo de equipamento √© ${appState.equipmentType}. Inclua uma breve descri√ß√£o da atividade de manuten√ß√£o, como inspe√ß√£o ou reparo, e o estado geral do equipamento. Mantenha o tom profissional e conciso.`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: "Voc√™ √© um gerador de resumo de relat√≥rio de servi√ßo t√©cnico." }]
                }
            };

            try {
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    summaryText.textContent = generatedText;
                    summaryContainer.classList.remove('hidden');
                    showMessage("Resumo gerado com sucesso!", false);
                } else {
                    showMessage("N√£o foi poss√≠vel gerar o resumo. Tente novamente.", true);
                }

            } catch (error) {
                console.error("Erro na chamada da API Gemini:", error);
                showMessage(`Erro ao gerar resumo: ${error.message}`, true);
            } finally {
                generateSummaryBtn.disabled = false;
            }
        });

        // Function to calculate distance between two lat/long points using the Haversine formula
        function calculateDistance(start, end) {
            const R = 6371; // Radius of the Earth in kilometers
            const lat1 = start.latitude;
            const lon1 = start.longitude;
            const lat2 = end.latitude;
            const lon2 = end.longitude;

            // Convert degrees to radians
            const toRadians = (deg) => deg * (Math.PI / 180);
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);

            // Haversine formula
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in kilometers
        }

        // --- Photo Capture Functions ---
        takePhotoButton.addEventListener('click', () => {
            photoFileInput.click();
        });

        photoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store the Base64 data
                    appState.photoData = e.target.result;
                    // Display the image preview
                    photoPreview.src = appState.photoData;
                    photoDisplay.classList.remove('hidden');
                    showMessage("Foto capturada com sucesso!");
                };
                reader.readAsDataURL(file);
            }
        });


        // Event Listeners for the main app
        startScanBtn.addEventListener('click', () => {
            if (!osInput.value.trim()) {
                showMessage("Por favor, digite o n√∫mero da O.S. antes de escanear.", true);
                return;
            }
            appState.osNumber = osInput.value.trim();
            osText.textContent = appState.osNumber;
            osDisplay.classList.remove('hidden');
            appState.scanMode = 'start';
            startScanner();
        });

        finishScanBtn.addEventListener('click', () => {
            if (!appState.start.timestamp) {
                showMessage("Por favor, inicie o servi√ßo primeiro.", true);
                return;
            }
            appState.scanMode = 'end';
            startScanner();
        });

        saveDataBtn.addEventListener('click', () => {
            if (!appState.osNumber || !appState.barcodeData || !appState.start.timestamp || !appState.end.timestamp || !appState.end.location) {
                showMessage("Por favor, complete todos os campos e escaneamentos antes de salvar.", true);
                return;
            }

            // Capture observations from the textarea
            appState.observations = observationsTextArea.value.trim();
            if (appState.observations) {
                 observationsTextDisplay.textContent = appState.observations;
                 observationsDisplay.classList.remove('hidden');
            }

            // Calculate the distance between start and end locations
            const distanceKm = calculateDistance(appState.start.location, appState.end.location);
            distanceText.textContent = `${distanceKm.toFixed(2)} km`;
            distanceDisplay.classList.remove('hidden');

            // This is the data object that you will pass to Power Apps.
            const dataToSave = {
                'OrdemDeServico': appState.osNumber,
                'CodigoDeBarras': appState.barcodeData,
                'TipoDeEquipamento': appState.equipmentType,
                'NumeroInventario': appState.inventoryNumber,
                'InicioDoServico': appState.start.timestamp.toISOString(),
                'FimDoServico': appState.end.timestamp.toISOString(),
                'LocalizacaoInicio': appState.start.location,
                'LocalizacaoFim': appState.end.location,
                'DistanciaPercorridaKm': distanceKm,
                'Observacoes': appState.observations,
                'FotoEmBase64': appState.photoData, // New: Photo data added to the object
            };

            // In Power Apps, you would use a "Patch" or "Collect" function
            // to send this object to your SharePoint list.
            // For this HTML file, we will just log it to the console.
            console.log("Dados prontos para serem enviados para o SharePoint:", JSON.stringify(dataToSave, null, 2));
            showMessage("Dados preparados para envio. No Power Apps, configure a a√ß√£o para enviar esses dados.");
        });

        osInput.addEventListener('input', () => {
             // Reset UI if OS number changes
            if (appState.barcodeData || appState.start.timestamp || appState.end.timestamp) {
                appState.barcodeData = '';
                appState.start.timestamp = null;
                appState.start.location = null;
                appState.end.timestamp = null;
                appState.end.location = null;
                appState.observations = '';
                observationsTextArea.value = '';
                appState.photoData = '';
                photoPreview.src = '';
                dataDisplay.classList.add('hidden');
                osDisplay.classList.add('hidden');
                startDataDisplay.classList.add('hidden');
                endDataDisplay.classList.add('hidden');
                startLocationDisplay.classList.add('hidden');
                endLocationDisplay.classList.add('hidden');
                distanceDisplay.classList.add('hidden');
                barcodeDisplay.classList.add('hidden');
                equipmentTypeDisplay.classList.add('hidden');
                inventoryDisplay.classList.add('hidden');
                observationsInputContainer.classList.add('hidden');
                observationsDisplay.classList.add('hidden');
                photoInputContainer.classList.add('hidden');
                photoDisplay.classList.add('hidden');
                finishScanBtn.style.display = 'none';
                generateSummaryBtn.style.display = 'none';
                summaryContainer.classList.add('hidden');
                saveDataBtn.classList.add('hidden');
                startScanBtn.style.display = 'block';
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            setupLoginDropdowns();
        });
    </script>
</body>
</html>

