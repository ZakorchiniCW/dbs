<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Servi칞o - Vers칚o Simples</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f5;
            /* **AJUSTE DE TECLADO M칍VEL** */
            min-height: 100vh;
            padding-top: 1.5rem; 
            padding-bottom: 5rem; /* Padding extra para evitar que o teclado esconda elementos */
        }
        /* ... Outros estilos ... */
        #reader {
            width: 100%;
            max-width: 400px;
            margin: auto;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px solid #a3b2b4;
            display: none;
        }
        .message-box {
            padding: 1rem;
            background-color: #d1e7e4;
            border-radius: 0.75rem;
            border: 1px solid #b7d6d1;
            margin-top: 1rem;
            display: none;
        }
        .data-display {
            background-color: #e6f0f2;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #c8d8e0;
            margin-top: 1.5rem;
        }
        .data-display div {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #a3b2b4;
        }
        .data-display div:last-child {
            border-bottom: none;
        }

        /* Estilo de Bot칚o Padr칚o (Finalizada - Verde Escuro) */
        .button-primary {
            /* Tailwind classes simulation */
            @apply text-white font-bold transition-all duration-300 ease-in-out;
            
            background-color: #00891d; 
            background-image: linear-gradient(180deg, #00893d 0%, #00891d 100%);
            border-radius: 9999px; 
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2), 0 0 10px rgba(57, 211, 121, 0.4);
            border: none;
        }
        .button-primary:hover {
            background-color: #00891d;
            background-image: linear-gradient(180deg, #00893d 0%, #00891d 100%);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3), 0 0 12px rgba(57, 211, 121, 0.6);
        }
        .button-primary:active {
            transform: scale(0.98); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1), 0 0 5px rgba(57, 211, 121, 0.2);
            background-image: linear-gradient(180deg, #00893d 0%, #00891d 100%);
        }

        /* Bot칚o secund치rio (Tirar Foto) */
        .button-secondary {
            /* Tailwind classes simulation */
            @apply bg-green-300 text-green-800 shadow-sm hover:bg-green-400 transition-colors;
            border-radius: 9999px; 
        }

        .green-led {
            height: 12px;
            width: 12px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 5px #4CAF50, 0 0 10px #4CAF50;
        }
        
        /* Modal Overlay Styles */
        #confirmation-modal, #manager-auth-modal, #barcode-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .input-with-unit-container {
            display: flex;
            align-items: center;
        }
        .input-with-unit {
            flex-grow: 1;
        }
        .unit-label {
            padding: 0.75rem;
            margin-left: -1px;
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            font-size: 0.875rem;
            color: #4b5563;
            font-weight: 500;
        }
        /* Style for Material Entry list */
        .material-entry {
            display: flex; justify-content: space-between; align-items: center; background-color: #f9fafb; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4"> 
    <div id="login-container" class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Login de Funcion치rio</h1>

        <div class="space-y-4">
            <div>
                <label for="company-select" class="block text-sm font-medium text-gray-700 mb-1">Empresa Terceirizada</label>
                <select id="company-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <option value="" disabled="" selected="">Selecione a empresa</option>
                    </select>
            </div>
            <div>
                <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-1">Nome do Funcion치rio</label>
                <select id="employee-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow" disabled="">
                    <option value="" disabled="" selected="">Selecione um funcion치rio</option>
                </select>
            </div>
            <div>
                <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input type="password" id="password-input" placeholder="Digite sua senha" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <button id="login-btn" class="w-full py-3 font-semibold text-lg button-primary">
                Entrar
            </button>
        </div>
        
        <div id="login-message-box" class="message-box" style="display:none;">
            <p id="login-message-text" class="text-sm font-medium text-gray-700"></p>
        </div>

    </div>

    <div id="app-container" class="bg-[#d1e7e4] rounded-xl shadow-lg p-6 max-w-sm w-full mx-auto" style="display:none;">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Registro de Servi칞o</h1>
        
        <p class="text-center text-gray-600 mb-4">Bem-vindo(a), <span id="logged-in-user"></span>!</p>

        <div class="mb-4">
            <label for="os-number" class="block text-sm font-medium text-gray-700 mb-1">N칰mero da Ordem de Servi칞o</label>
            <input type="text" id="os-number" placeholder="Digite a O.S." class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            
            <div id="service-active-status" class="mt-2 hidden items-center justify-between p-2 bg-green-100 border border-green-300 rounded-lg">
                <p class="text-sm font-semibold text-green-700 flex items-center">
                    <span class="green-led mr-2"></span>
                    O.S. <span id="os-text-active" class="ml-1 font-bold"></span> - Ativa e em Andamento.
                </p>
            </div>
        </div>

        <div id="reader"></div>

        <div id="action-buttons" class="flex flex-col space-y-3">
            <button id="start-scan-btn" class="w-full py-3 font-semibold text-lg button-primary">
                Escanear para Iniciar
            </button>
            <button id="finish-scan-btn" class="w-full py-3 font-semibold text-lg button-primary" style="display:none;">
                Escanear para Finalizar
            </button>
        </div>
        
        <div id="lubrica-info-field" class="data-display hidden mt-4">
            <h2 class="text-lg font-bold text-gray-800 mb-1">Informa칞칫es de Reposi칞칚o</h2>
            <p id="lubrica-info-content" class="text-sm text-gray-700 font-mono whitespace-pre-wrap"></p>
        </div>

        <div id="photo-input-container" class="mt-4 hidden">
             <input type="file" id="photo-file-input" accept="image/*" capture="camera" class="hidden"> 
             <button id="take-photo-btn" class="w-full py-3 rounded-lg font-semibold text-lg button-secondary">
                Tirar Foto 游닞
            </button>
            
            <div id="photo-preview-container" class="mt-3 flex flex-wrap gap-2">
                 </div>
        </div>
        
        <div id="observations-input-container" class="mt-4 hidden">
            <label for="observations-text" class="block text-sm font-medium text-gray-700 mb-1">Observa칞칫es do T칠cnico</label>
            <textarea id="observations-text" placeholder="Descreva o servi칞o realizado, pend칡ncias, etc." rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow"></textarea>
        </div>
        
        <div id="materials-input-container" class="mt-4 hidden space-y-3">
            <h2 class="block text-sm font-bold text-gray-700 mb-2">Uso de Materiais (Reposi칞칚o)</h2>
            
            <div id="material-entry-form" class="p-3 border border-gray-300 rounded-lg bg-white space-y-3">
                 <div>
                    <label for="material-select" class="block text-sm font-medium text-gray-700 mb-1">1. Material</label>
                    <select id="material-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="" disabled selected>Selecione o Material</option>
                        <option value="칍leo">칍leo</option>
                        <option value="Graxa">Graxa</option>
                        <option value="Parafina">Parafina</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <div class="flex-1">
                        <label for="material-quantity-input" class="block text-sm font-medium text-gray-700 mb-1">2. Quantidade</label>
                        <div class="input-with-unit-container">
                             <input type="number" id="material-quantity-input" placeholder="0.00" min="0" step="any" class="input-with-unit w-full p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                             <span id="material-quantity-unit" class="unit-label rounded-l-none">Unidade</span>
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <label for="material-type-select" class="block text-sm font-medium text-gray-700 mb-1">3. Tipo Espec칤fico</label>
                        <select id="material-type-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                            <option value="" disabled selected>Selecione o Tipo</option>
                        </select>
                    </div>
                </div>

                <button id="add-material-btn" class="w-full py-2 px-4 rounded-lg font-semibold text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                    + Adicionar Material
                </button>
            </div>
            
            <h3 class="block text-sm font-bold text-gray-700 mt-4 mb-1">Materiais Registrados:</h3>
            <div id="materials-list" class="space-y-2">
                <p id="no-materials-message" class="text-sm italic text-gray-600">Nenhum material adicionado.</p>
                </div>
        </div>

     
        
        <button id="finalize-service-btn" class="w-full py-3 font-bold text-lg button-primary mt-6 hidden">
            Finalizar Servi칞o
        </button>
        
        <div id="manager-check-container" class="data-display hidden text-center">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Acesso Gerencial</h2>
            <p class="text-gray-700 mb-4">Deseja checar a Ordem de Servi칞o finalizada/interrompida?</p>
            <button id="manager-auth-btn" class="py-3 px-6 font-semibold text-lg button-primary">
                OK
            </button>
        </div>


        <div id="message-box" class="message-box" style="display:none;">
            <p id="message-text" class="text-sm font-medium text-gray-700"></p>
        </div>

        <div id="data-display" class="data-display hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Relat칩rio de Servi칞o</h2>

            <div id="manager-alarm-box" class="p-3 bg-red-200 border border-red-400 rounded-lg mb-4 hidden">
                </div>
            
            <div id="company-report-display">
                <span class="font-semibold text-gray-600">Empresa:</span> <span id="company-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="employee-report-display">
                <span class="font-semibold text-gray-600">Funcion치rio:</span> <span id="employee-text" class="font-medium text-gray-800"></span>
            </div>

            <div id="os-display">
                <span class="font-semibold text-gray-600">O.S.:</span> <span id="os-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="status-display">
                <span class="font-semibold text-gray-600">Status:</span> <span id="service-status-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="barcode-display">
                <span class="font-semibold text-gray-600">C칩d. de Barras:</span> <span id="barcode-text" class="font-medium text-gray-800"></span>
            </div>
             <div id="equipment-type-display">
                <span class="font-semibold text-gray-600">Tipo de Equipamento:</span> <span id="equipment-type-text" class="font-medium text-gray-800"></span>
            </div>
            
            <div id="materials-report-display">
                <span class="font-semibold text-gray-600">Materiais Utilizados:</span> 
                <div id="materials-report-text" class="font-medium text-gray-800"></div>
            </div>

            <div id="start-data-display">
                <span class="font-semibold text-gray-600">In칤cio:</span> <span id="start-datetime-text" class="font-medium text-gray-800"></span>
            </div>
            <div>
                <span class="font-semibold text-gray-600">Localiza칞칚o In칤cio:</span> <span id="start-location-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="end-data-display">
                <span class="font-semibold text-gray-600">Fim:</span> <span id="end-datetime-text" class="font-medium text-gray-800"></span>
            </div>
            <div>
                <span class="font-semibold text-gray-600">Localiza칞칚o Fim:</span> <span id="end-location-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="distance-display">
                <span class="font-semibold text-gray-600">Dist칙ncia Percorrida:</span> <span id="distance-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="observations-display">
                <span class="font-semibold text-gray-600">Observa칞칫es:</span> <span id="observations-text-display" class="font-medium text-gray-800 whitespace-pre-wrap"></span>
            </div>
             <div id="photos-report-display">
                <span class="font-semibold text-gray-600">Fotos Capturadas:</span>
                <div id="photos-report-preview-container" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </div>
        
        <div id="summary-container" class="data-display hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Resumo do Servi칞o (IA)</h2>
            <p id="summary-text" class="text-gray-700 text-sm italic">Resumo de IA desativado conforme solicitado.</p>
        </div>
        
        <button id="report-close-btn" class="w-full py-3 font-bold text-lg button-primary mt-6 hidden">
            Encerrar (Voltar ao In칤cio)
        </button>

    </div>
    
    <div id="confirmation-modal">
        <div id="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Confirma칞칚o de Servi칞o</h3>
            <p class="mb-4 text-gray-600">O servi칞o na O.S. <span id="modal-os-number" class="font-bold"></span> foi:</p>
            <div class="flex flex-col space-y-3">
                <button id="modal-finalize-btn" class="py-3 font-semibold text-lg button-primary">
                    Finalizada
                </button>
                <button id="modal-interrupt-btn" class="py-3 rounded-lg font-semibold text-lg button-secondary">
                    Interrompida
                </button>
            </div>
        </div>
    </div>
    
    <div id="manager-auth-modal">
        <div id="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Autentica칞칚o Gerencial</h3>
            <p class="mb-4 text-gray-600">Para visualizar o relat칩rio, o Gerente deve se autenticar.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="manager-select" class="block text-sm font-medium text-gray-700 mb-1">Nome do Gerente</label>
                    <select id="manager-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="" disabled="" selected="">Selecione o Gerente</option>
                        <option value="Gerente">Gerente</option>
                    </select>
                </div>
                <div>
                    <label for="manager-password-input" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="manager-password-input" placeholder="Digite sua senha" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                </div>
                <button id="manager-login-btn" class="w-full py-3 font-semibold text-lg button-primary">
                    Acessar Relat칩rio
                </button>
            </div>

             <div id="manager-message-box" class="message-box mt-3" style="display:none; background-color: #fca5a5; border-color: #ef4444;">
                <p id="manager-message-text" class="text-sm font-medium text-red-800"></p>
            </div>
        </div>
    </div>

    <div id="barcode-confirmation-modal">
        <div id="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Confirmar C칩digo de Barras</h3>
            <p class="mb-2 text-gray-600">O c칩digo escaneado foi:</p>
            <p id="scanned-code-display" class="text-2xl font-bold mb-4 p-3 bg-gray-100 rounded-lg text-center break-all text-gray-800"></p>
            <p class="mb-4 text-gray-600">Confirma que esta numera칞칚o est치 correta?</p>
            <div class="flex flex-col space-y-3">
                <button id="modal-confirm-barcode-btn" class="py-3 font-semibold text-lg button-primary">
                    Sim, Continuar
                </button>
                <button id="modal-rescan-barcode-btn" class="py-3 rounded-lg font-semibold text-lg" style="background-color: #fcd34d; color: #92400e;">
                    N칚o, Escanear Novamente
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // Data base para vetores de conformidade (Vers칚o 2)
        const MATERIAL_DATA = {
            "칍leo": { 
                unit: "Litros", 
                lastReplenishmentDate: "2025-10-01", // Data da 칔ltima Reposi칞칚o (YYYY-MM-DD)
                minIntervalDays: 30, // Intervalo M칤nimo (dias)
                types: { 
                    "칍leo 32": 1, // Limite de Quantidade (CORRIGIDO)
                    "칍leo OSO 46": 1  // Limite de Quantidade (CORRIGIDO)
                } 
            },
            "Graxa": { 
                unit: "Kilos", 
                lastReplenishmentDate: "2025-10-01",
                minIntervalDays: 30,
                types: { 
                    "Graxa A": 1, // Limite de Quantidade (CORRIGIDO)
                    "Graxa B": 1  // Limite de Quantidade (CORRIGIDO)
                } 
            },
            "Parafina": { 
                unit: "Litros", 
                lastReplenishmentDate: "2025-10-01",
                minIntervalDays: 30,
                types: { 
                    "Branca": 1,      // Limite de Quantidade (CORRIGIDO)
                    "Translucida": 1  // Limite de Quantidade (CORRIGIDO)
                } 
            }
        };
        
         // VETORES SIMPLES INFORMATIVOS (MANTIDOS E CORRIGIDOS COMO SOLICITADO)
         const BARCODE_LUBRICA_CHECK = ["%H0076936", "%H0075089", "%H4076936", "%H4075089", "M12234967"];
        const MAQUINA_NOME = "Ret칤fica AFE 2S-88";
        const MATERIAL_OLEO = "칍leo Hidr치ulico do tipo OSO 46";  
        const MATERIAL_GRAXA = "Graxa de lubrifica칞칚o do tipo B"; 
        const MATERIAL_PARAFINA = "Parafina do tipo Branca";         

        // Main application state and data container
        const appState = {
            osNumber: '',
            barcodeData: '',
            equipmentType: '',
            inventoryNumber: '',
            observations: '',
            photoData: [], 
            serviceStatus: '',
            materialsUsed: [], 
            limitExceededMaterials: [], 
            dateAlarms: [], 
            loggedInCompany: '', 
            loggedInEmployee: '', 
            start: {
                timestamp: null,
                location: null,
            },
            end: {
                timestamp: null,
                location: null,
            },
            scanMode: 'start',
            isServiceActive: false, 
            finalReportData: null, 
        };

        // Mock data for login (Funcion치rio: '123', Gerente: '123')
        const loginData = {
            "Arcondi": { 
                "Abc": "123", 
                "Def": "123", 
                "Ghi": "123",
            },
            "Lubrica": { 
                "Jk": "123", 
                "Lm": "123", 
                "No": "123" 
            }
        };
        const MANAGER_USERNAME = "Gerente";
        const MANAGER_PASSWORD = "123";
        
        // --- NOVO: DETEC칂츾O DE AMBIENTE (Crucial para for칞ar o fallback) ---
        function isEdgeOnIPad() {
            const userAgent = navigator.userAgent.toLowerCase();
            // A Apple for칞ou todos os navegadores no iOS/iPadOS a usar o WebKit (e se identificar como Mac/iPad)
            const isIPad = /ipad|macintosh/.test(userAgent) && 'ontouchend' in document; 
            const isEdge = /edg/.test(userAgent);
            return isIPad && isEdge;
        }
        // ------------------------------------------------------------------

        // DOM element references
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const companySelect = document.getElementById('company-select');
        const employeeSelect = document.getElementById('employee-select');
        const passwordInput = document.getElementById('password-input');
        const loggedInUserText = document.getElementById('logged-in-user');
        const loginBtn = document.getElementById('login-btn'); 

        const osInput = document.getElementById('os-number');
        const startScanBtn = document.getElementById('start-scan-btn');
        const finishScanBtn = document.getElementById('finish-scan-btn');
        const finalizeServiceBtn = document.getElementById('finalize-service-btn');
        const reportCloseBtn = document.getElementById('report-close-btn');

        const readerDiv = document.getElementById('reader');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const serviceActiveStatus = document.getElementById('service-active-status');

        const observationsTextArea = document.getElementById('observations-text');
        const observationsInputContainer = document.getElementById('observations-input-container');
        const photoInputContainer = document.getElementById('photo-input-container');
        const photoFileInput = document.getElementById('photo-file-input');
        const photoPreviewContainer = document.getElementById('photo-preview-container');

        // Material Input Elements
        const materialInputContainer = document.getElementById('materials-input-container');
        const materialSelect = document.getElementById('material-select');
        const materialQuantityInput = document.getElementById('material-quantity-input');
        const materialTypeSelect = document.getElementById('material-type-select');
        const materialQuantityUnit = document.getElementById('material-quantity-unit');
        const addMaterialBtn = document.getElementById('add-material-btn');
        const materialsList = document.getElementById('materials-list');
        
        // NOVO CAMPO INFORMATIVO (REQUISITO LUBRICA)
        const lubricaInfoField = document.getElementById('lubrica-info-field');
        const lubricaInfoContent = document.getElementById('lubrica-info-content');

        // Barcode Confirmation Modal Elements
        const barcodeConfirmationModal = document.getElementById('barcode-confirmation-modal');
        const scannedCodeDisplay = document.getElementById('scanned-code-display');
        const modalConfirmBarcodeBtn = document.getElementById('modal-confirm-barcode-btn');
        const modalRescanBarcodeBtn = document.getElementById('modal-rescan-barcode-btn');

        let html5QrCode;
        let pendingDecodedText = ''; 
        let pendingScanMode = ''; 
        
        // --- Input de arquivo tempor치rio para o fallback (Crucial para Edge/iPad) ---
        const barcodeFileInput = document.createElement('input');
        barcodeFileInput.type = 'file';
        barcodeFileInput.accept = 'image/*';
        barcodeFileInput.capture = 'environment'; // For칞a c칙mera traseira em iOS
        barcodeFileInput.className = 'hidden'; 
        document.body.appendChild(barcodeFileInput); 
        // ---------------------------------------------------------------------------------

        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.style.display = 'block';
            if (isError) {
                messageBox.style.backgroundColor = '#fca5a5'; /* red-300 */
                messageText.style.color = '#991b1b'; /* red-800 */
            } else {
                messageBox.style.backgroundColor = '#d1e7e4'; /* light green */
                messageText.style.color = '#374151'; /* gray-700 */
            }
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }
        
        function resetAppState() {
            // Limpa o estado da O.S. (mas MANT칄M a empresa e o funcion치rio logado)
            appState.osNumber = '';
            appState.barcodeData = '';
            appState.equipmentType = '';
            appState.inventoryNumber = '';
            appState.observations = '';
            appState.photoData = [];
            appState.serviceStatus = '';
            appState.materialsUsed = []; 
            appState.limitExceededMaterials = []; 
            appState.dateAlarms = []; 
            appState.start.timestamp = null;
            appState.start.location = null;
            appState.end.timestamp = null;
            appState.end.location = null;
            appState.scanMode = 'start';
            appState.finalReportData = null;
            appState.isServiceActive = false; 
            pendingDecodedText = ''; 
            pendingScanMode = ''; 
            
            osInput.value = '';
            observationsTextArea.value = '';
            photoPreviewContainer.innerHTML = '';
            
            materialSelect.value = '';
            materialQuantityInput.value = '';
            materialTypeSelect.innerHTML = '<option value="" disabled selected>Selecione o Tipo</option>';
            materialQuantityUnit.textContent = 'Unidade';
            materialsList.innerHTML = '<p id="no-materials-message" class="text-sm italic text-gray-600">Nenhum material adicionado.</p>';
            
            lubricaInfoField.classList.add('hidden'); // Esconde o campo informativo

            document.getElementById('data-display').classList.add('hidden');
            document.getElementById('summary-container').classList.add('hidden');
            reportCloseBtn.classList.add('hidden');
            serviceActiveStatus.classList.add('hidden');
            observationsInputContainer.classList.add('hidden');
            photoInputContainer.classList.add('hidden');
            materialInputContainer.classList.add('hidden'); 
            finishScanBtn.style.display = 'none';
            finalizeServiceBtn.classList.add('hidden');
            document.getElementById('manager-check-container').classList.add('hidden'); 
            document.getElementById('manager-auth-modal').style.display = 'none'; 
            document.getElementById('manager-alarm-box').classList.add('hidden'); 
            barcodeConfirmationModal.style.display = 'none'; 
            
            osInput.disabled = false;
            osInput.style.display = 'block';
            startScanBtn.style.display = 'block';

            // Reseta a interface para o estado inicial (logado, pronto para come칞ar)
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            
            showMessage("Pronto para uma nova Ordem de Servi칞o!");
        }

        // Fun칞칚o para voltar  tela de Login
        function transitionToLoginUI() {
            // IMPORTANTE: Limpa o estado da empresa logada e funcion치rio
            appState.loggedInCompany = '';
            appState.loggedInEmployee = '';
            loggedInUserText.textContent = '';

            loginContainer.style.display = 'block';
            appContainer.style.display = 'none';
            
            // Limpa campos do login
            employeeSelect.value = '';
            passwordInput.value = '';
            companySelect.value = '';
            employeeSelect.disabled = true;
            employeeSelect.innerHTML = '<option value="" disabled selected>Selecione um funcion치rio</option>';
        }

       function transitionToActiveServiceUI() {
            appState.isServiceActive = true;

            osInput.disabled = true;
            osInput.style.display = 'none';
            startScanBtn.style.display = 'none';

            document.getElementById('os-text-active').textContent = appState.osNumber;
            serviceActiveStatus.classList.remove('hidden');
            finishScanBtn.style.display = 'block';
            
            observationsInputContainer.classList.remove('hidden');
            photoInputContainer.classList.remove('hidden');

            // Condi칞칚o para exibir gerenciamento de materiais e o campo informativo (NOVO)
            if (appState.loggedInCompany === 'Lubrica') {
                materialInputContainer.classList.remove('hidden');
                
                // L칩gica de exibi칞칚o do campo informativo simples
                 if (BARCODE_LUBRICA_CHECK.includes(appState.barcodeData)) {
                    
                    // CORRE칂츾O: Usando innerHTML e tags <strong> para negrito.
                    lubricaInfoContent.innerHTML = 
                        `<strong>"${MAQUINA_NOME}"</strong><br>` +
                        `<strong>"${MATERIAL_OLEO}"</strong><br>` + 
                        `<strong>"${MATERIAL_GRAXA}"</strong><br>` + 
                        `<strong>"${MATERIAL_PARAFINA}"</strong>`;
                    
                    lubricaInfoField.classList.remove('hidden');
                } else {
                    lubricaInfoField.classList.add('hidden');
                }

            } else {
                materialInputContainer.classList.add('hidden');
                lubricaInfoField.classList.add('hidden');
            }
            
            finalizeServiceBtn.classList.add('hidden');
            finalizeServiceBtn.disabled = true;
        }
        
        function showBarcodeConfirmationModal(decodedText, scanMode) {
            pendingDecodedText = decodedText;
            pendingScanMode = scanMode;

            scannedCodeDisplay.textContent = decodedText;
            barcodeConfirmationModal.style.display = 'flex';
        }

        function continueScanProcess() {
            barcodeConfirmationModal.style.display = 'none';
            const decodedText = pendingDecodedText;
            const scanMode = pendingScanMode;
            
            // Reset pending variables
            pendingDecodedText = '';
            pendingScanMode = '';

            if (scanMode === 'start') {
                handleStartScanSuccess(decodedText);
            } else {
                handleFinishScanSuccess();
            }
        }

        // --- FUN칂츾O DE FALLBACK PARA CAPTURA DE IMAGEM (Edge/iPad) ---
        function startImageCaptureFallback(scanMode) {
            // Garante que o html5QrCode esteja parado
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(() => {});
            }
            
            // Oculta a div do leitor
            readerDiv.style.display = 'none';
            
            // Armazena o modo atual para uso no callback
            pendingScanMode = scanMode;
            
            // Adiciona um listener tempor치rio e dispara o clique no input de arquivo
            barcodeFileInput.onchange = handleImageCaptureFallback;
            barcodeFileInput.click();
            
            showMessage("O scanner falhou. Use a c칙mera para tirar uma foto do c칩digo de barras.", false);
        }

        function handleImageCaptureFallback(event) {
            const file = event.target.files[0];
            barcodeFileInput.onchange = null; // Remove o listener

            if (file) {
                // Re-instancia o objeto com a div de exibi칞칚o, embora ela n칚o seja usada para scanFile
                html5QrCode = new Html5Qrcode("reader"); 

                html5QrCode.scanFile(file, true)
                    .then(decodedText => {
                        // Simula o sucesso do escaneamento do c칩digo de barras
                        showBarcodeConfirmationModal(decodedText, pendingScanMode);
                    })
                    .catch(err => {
                        console.error("Erro ao ler o c칩digo de barras da imagem capturada:", err);
                        showMessage("Erro ao ler o c칩digo de barras da imagem capturada. Tente novamente.", true);
                        resetUIScannerFail();
                    });
            } else {
                // Usu치rio cancelou a foto
                showMessage("Captura de c칩digo de barras cancelada. Tente novamente.", false);
                resetUIScannerFail();
            }
            // Limpa o valor do input para permitir nova captura
            event.target.value = null; 
        }
        // ---------------------------------------------------------------------------------

        // --- NOVO startScanner com detec칞칚o de Edge/iPad e FOR칂A do Fallback ---
        function startScanner() {
            try {
                if (typeof Html5Qrcode === 'undefined') {
                    throw new Error("A biblioteca do scanner (Html5Qrcode) n칚o foi carregada.");
                }

                const os = osInput.value.trim();
                if (appState.scanMode === 'start' && !os) {
                    showMessage("Por favor, digite o n칰mero da O.S. antes de escanear.", true);
                    return;
                }
                if (appState.scanMode === 'start') {
                    appState.osNumber = os;
                }
                
                // --- VERIFICA칂츾O CONDICIONAL ---
                if (isEdgeOnIPad()) {
                     // Se Edge/iPad, IGNORA WebRTC e vai DIRETO para a solu칞칚o est치vel.
                     console.log("Detectado Edge no iPad. Ignorando WebRTC e iniciando captura de imagem.");
                     startImageCaptureFallback(appState.scanMode);
                     return; // Sai da fun칞칚o aqui.
                }
                // --- FIM DA VERIFICA칂츾O CONDICIONAL ---


                readerDiv.style.display = 'block';
                serviceActiveStatus.classList.add('hidden');
                finishScanBtn.style.display = 'none';
                finalizeServiceBtn.classList.add('hidden'); 
                materialInputContainer.classList.add('hidden'); 
                observationsInputContainer.classList.add('hidden');
                photoInputContainer.classList.add('hidden');
                lubricaInfoField.classList.add('hidden'); 
                startScanBtn.style.display = 'none';

                // Tentativa WebRTC padr칚o (para outros navegadores)
                const constraints = null; 
                
                const config = {
                    fps: 15, 
                    qrbox: { width: 250, height: 250 },
                    formatsToSupport: ["CODE_128", "QR_CODE", "CODE_39"],
                    videoConstraints: {
                        facingMode: "environment",
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 }
                    }
                };
                
                html5QrCode = new Html5Qrcode("reader");

                html5QrCode.start( constraints, config,
                    (decodedText, decodedResult) => {
                        html5QrCode.stop().then(() => {
                            // Sucesso do WebRTC
                            showBarcodeConfirmationModal(decodedText, appState.scanMode); 
                            readerDiv.style.display = 'none';
                        }).catch(err => {
                            console.error("Error stopping scanner:", err);
                            showMessage("Erro ao parar o scanner.", true);
                            resetUIScannerFail();
                        });
                    },
                    (errorMessage) => { /* Ignore continuous error messages */ }
                ).catch(err => {
                    console.error("Erro ao iniciar o scanner WebRTC:", err);
                    // Fallback para navegadores que n칚o s칚o Edge/iPad, mas falham no WebRTC
                    startImageCaptureFallback(appState.scanMode);
                });
            } catch (err) {
                console.error("Erro geral ao iniciar o scanner:", err);
                startImageCaptureFallback(appState.scanMode);
            }
        }
        // --- Fim do startScanner ---
        
        function resetUIScannerFail() {
             readerDiv.style.display = 'none';
             pendingDecodedText = ''; 
             pendingScanMode = ''; // Garante o reset do modo pendente
             
             if (appState.isServiceActive) {
                // Se estava ativo, volta para a interface ativa (sem o scanner)
                serviceActiveStatus.classList.remove('hidden');
                finishScanBtn.style.display = 'block';
                // Mostra materiais/obs/fotos dependendo da empresa
                if (appState.loggedInCompany === 'Lubrica') { 
                    materialInputContainer.classList.remove('hidden');
                    // Tenta re-exibir o campo informativo se o barcode j치 estiver no estado
                    if (BARCODE_LUBRICA_CHECK.includes(appState.barcodeData)) {
                         lubricaInfoField.classList.remove('hidden');
                    }
                }
                observationsInputContainer.classList.remove('hidden');
                photoInputContainer.classList.remove('hidden');
             } else {
                // Se n칚o estava ativo, volta para a tela inicial
                osInput.style.display = 'block';
                startScanBtn.style.display = 'block';
             }
        }
        
        function handleStartScanSuccess(decodedText) {
            showMessage("C칩digo de barras escaneado e confirmado! Servi칞o Iniciado.");
            
            const equipmentType = decodedText.charAt(0).toUpperCase();
            const inventoryNumber = decodedText.substring(1);

            appState.barcodeData = decodedText;
            appState.equipmentType = equipmentType;
            appState.inventoryNumber = inventoryNumber;

            appState.start.timestamp = new Date();
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = position.coords;
                        appState.start.location = { latitude: coords.latitude, longitude: coords.longitude, accuracy: coords.accuracy };
                        showMessage("Localiza칞칚o de in칤cio obtida com sucesso!");
                    },
                    (error) => {
                        console.error("Geolocation error (start):", error);
                        showMessage("N칚o foi poss칤vel obter a localiza칞칚o de in칤cio.", true);
                    }
                );
            } else {
                showMessage("Seu navegador n칚o suporta geolocaliza칞칚o.", true);
            }
            transitionToActiveServiceUI();
        }

        function handleFinishScanSuccess() {
            showMessage("Escaneamento de Finaliza칞칚o conclu칤do e confirmado. Pronto para Finalizar Servi칞o.");
            
            appState.end.timestamp = new Date();
            
            serviceActiveStatus.classList.remove('hidden'); 
            
            // Mostra materiais/obs/fotos dependendo da empresa
            if (appState.loggedInCompany === 'Lubrica') { 
                materialInputContainer.classList.remove('hidden');
                 // Mant칠m o campo informativo vis칤vel se aplic치vel
                 if (BARCODE_LUBRICA_CHECK.includes(appState.barcodeData)) {
                     lubricaInfoField.classList.remove('hidden');
                }
            }
            observationsInputContainer.classList.remove('hidden');
            photoInputContainer.classList.remove('hidden');
            
            finalizeServiceBtn.classList.remove('hidden'); 
            finalizeServiceBtn.disabled = false; 
            finishScanBtn.style.display = 'none'; 
            appState.scanMode = 'end-done'; 

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = position.coords;
                        appState.end.location = { latitude: coords.latitude, longitude: coords.longitude, accuracy: coords.accuracy };
                    },
                    (error) => {
                        console.error("Geolocation error (end):", error);
                        showMessage("Localiza칞칚o de encerramento n칚o capturada.", true);
                    }
                );
            }
        }

        function runMaterialChecks() {
            // Pular checagem de materiais se a empresa n칚o for "Lubrica"
            if (appState.loggedInCompany !== 'Lubrica') {
                appState.limitExceededMaterials = [];
                appState.dateAlarms = [];
                return true; 
            }
            
            appState.limitExceededMaterials = [];
            appState.dateAlarms = []; 
            let allGood = true;
            
            // --- 1. Checagem de Intervalo M칤nimo de Reposi칞칚o (Data) ---
            if (appState.end.timestamp && appState.materialsUsed.length > 0) {
                const currentServiceDate = appState.end.timestamp; 
                const dateAlarmSet = new Set(); 

                appState.materialsUsed.forEach(entry => {
                    const { material } = entry;
                    
                    if (dateAlarmSet.has(material)) return;

                    const materialConfig = MATERIAL_DATA[material];
                    const lastDateString = materialConfig.lastReplenishmentDate;
                    const minInterval = materialConfig.minIntervalDays;

                    const parts = lastDateString.split('-'); // Espera YYYY-MM-DD
                    // Subtrai 1 do m칡s pois JavaScript usa 0-indexed (0=Jan, 11=Dec)
                    const lastDate = new Date(parts[0], parts[1] - 1, parts[2]); 

                    const minAllowedDate = new Date(lastDate);
                    minAllowedDate.setDate(lastDate.getDate() + minInterval); 

                    if (currentServiceDate < minAllowedDate) {
                        allGood = false;
                        dateAlarmSet.add(material); 
                        
                        appState.dateAlarms.push({
                            material: material,
                            lastDate: lastDate.toLocaleDateString('pt-BR'),
                            minInterval: minInterval,
                            currentDate: currentServiceDate.toLocaleDateString('pt-BR'),
                            minAllowedDate: minAllowedDate.toLocaleDateString('pt-BR'),
                        });
                        showMessage(`丘멆잺 ALARME: Reposi칞칚o de ${material} feita muito cedo! Prazo m칤nimo: ${minInterval} dias.`, true);
                    }
                });
            }


            // --- 2. Checagem de Limite de Quantidade ---
            appState.materialsUsed.forEach(entry => {
                const { material, quantity, type, unit } = entry;
                
                const limit = MATERIAL_DATA[material].types[type]; 

                if (quantity > limit) {
                    allGood = false;
                    appState.limitExceededMaterials.push({
                        material,
                        type,
                        quantityUsed: quantity,
                        limit: limit,
                        unit: unit,
                    });
                    showMessage(`丘멆잺 ALARME: O uso de ${material} (${type}) excedeu o limite planejado de ${limit} ${unit} (Quantidade: ${quantity})!`, true);
                }
            });

            return allGood; 
        }

        function calculateDistance(start, end) {
             if (!start || !end) return 0;
            const R = 6371;
            const lat1 = start.latitude;
            const lon1 = start.longitude;
            const lat2 = end.latitude;
            const lon2 = end.longitude;
            const toRadians = (deg) => deg * (Math.PI / 180);
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function prepareReportData() {
            runMaterialChecks(); 
            
            appState.observations = observationsTextArea.value.trim();
            const distanceKm = calculateDistance(appState.start.location, appState.end.location);
            
            const report = {
                osNumber: appState.osNumber,
                serviceStatus: appState.serviceStatus,
                barcodeData: appState.barcodeData,
                equipmentType: appState.equipmentType,
                materialsUsed: [...appState.materialsUsed],
                limitExceededMaterials: [...appState.limitExceededMaterials],
                dateAlarms: [...appState.dateAlarms], 
                
                // Dados do Prestador de Servi칞o
                company: appState.loggedInCompany,
                employee: appState.loggedInEmployee,
                
                start: {
                    timestamp: appState.start.timestamp,
                    location: appState.start.location,
                },
                end: {
                    timestamp: appState.end.timestamp,
                    location: appState.end.location,
                },
                distance: distanceKm,
                observations: appState.observations,
                photoData: [...appState.photoData], 
            };

            report.aiSummary = 'Resumo de IA desativado conforme solicitado.';

            appState.finalReportData = report;

            transitionToManagerCheckUI();
        }

        function transitionToManagerCheckUI() {
            serviceActiveStatus.classList.add('hidden');
            finishScanBtn.style.display = 'none';
            finalizeServiceBtn.classList.add('hidden');
            materialInputContainer.classList.add('hidden'); 
            observationsInputContainer.classList.add('hidden');
            photoInputContainer.classList.add('hidden');
            lubricaInfoField.classList.add('hidden'); // Esconde o campo informativo

            document.getElementById('manager-check-container').classList.remove('hidden');
            showMessage("Servi칞o finalizado. Aguardando confer칡ncia do Gerente.");
        }

        function displayFinalReport() {
            if (!appState.finalReportData) return;

            const report = appState.finalReportData;
            
            document.getElementById('manager-check-container').classList.add('hidden');
            document.getElementById('manager-auth-modal').style.display = 'none';
            const managerAlarmBox = document.getElementById('manager-alarm-box');
            const dataDisplay = document.getElementById('data-display');
            
            const hasAlarms = report.limitExceededMaterials.length > 0 || report.dateAlarms.length > 0;

            if (hasAlarms) {
                let alarmHtml = '<h3 class="font-bold text-lg text-red-800 mb-2">游뚿 ALARME DE CONFORMIDADE (URGENTE)</h3>';
                
                const equipmentID = report.barcodeData ? report.barcodeData.substring(1) : 'N/A';
                
                // 1. Alarmes de Intervalo M칤nimo (Data)
                if (report.dateAlarms.length > 0) {
                    alarmHtml += '<h4 class="font-semibold text-red-700 mt-3 mb-2">Intervalo M칤nimo N칚o Respeitado:</h4>';
                    alarmHtml += '<p class="text-sm text-red-800 mb-3">O intervalo entre reposi칞칫es foi muito curto. Avaliar por vazamento/defeito!</p>';
                    
                    report.dateAlarms.forEach(alarm => {
                        alarmHtml += `<div class="mb-2 p-2 border border-red-400 bg-red-100 rounded-lg">`;
                        alarmHtml += `<span class="font-semibold">M치quina/Equipamento:</span> ${equipmentID}<br/>`;
                        alarmHtml += `<span class="font-semibold">Material:</span> ${alarm.material}<br/>`;
                        alarmHtml += `<span class="font-semibold">칔ltima Reposi칞칚o:</span> ${alarm.lastDate}<br/>`;
                        alarmHtml += `<span class="font-semibold text-red-700">Reposi칞칚o M칤nima Permitida:</span> ${alarm.minAllowedDate} (Intervalo de ${alarm.minInterval} dias)<br/>`;
                        alarmHtml += `<span class="font-semibold text-red-700">Reposi칞칚o Atual:</span> ${alarm.currentDate}`;
                        alarmHtml += `</div>`;
                    });
                }

                // 2. Alarmes de Quantidade Excedida
                if (report.limitExceededMaterials.length > 0) {
                    alarmHtml += '<h4 class="font-semibold text-red-700 mt-3 mb-2">Quantidades Excedidas:</h4>';
                    alarmHtml += '<p class="text-sm text-red-800 mb-3">Avaliar urg칡ncia por poss칤veis vazamentos, danos ou desvio de material.</p>';
                    
                    report.limitExceededMaterials.forEach(alarm => {
                        const exceeded = (alarm.quantityUsed - alarm.limit).toFixed(2);
                        
                        alarmHtml += `<div class="mb-2 p-2 border border-red-400 bg-red-100 rounded-lg">`;
                        alarmHtml += `<span class="font-semibold">M치quina/Equipamento:</span> ${equipmentID}<br/>`; 
                        alarmHtml += `<span class="font-semibold">Material:</span> ${alarm.material} (${alarm.type})<br/>`;
                        alarmHtml += `<span class="font-semibold">Quant. Utilizada:</span> ${alarm.quantityUsed} ${alarm.unit}<br/>`;
                        alarmHtml += `<span class="font-semibold text-red-700">Quantidade Excedida:</span> ${exceeded} ${alarm.unit}`;
                        alarmHtml += `</div>`;
                    });
                }
                
                managerAlarmBox.innerHTML = alarmHtml;
                managerAlarmBox.classList.remove('hidden');

            } else {
                managerAlarmBox.classList.add('hidden');
            }

            // Popula dados da Empresa e Funcion치rio
            document.getElementById('company-text').textContent = report.company;
            document.getElementById('employee-text').textContent = report.employee;
            
            document.getElementById('os-text').textContent = report.osNumber;
            document.getElementById('service-status-text').textContent = report.serviceStatus;
            document.getElementById('barcode-text').textContent = report.barcodeData;
            document.getElementById('equipment-type-text').textContent = report.equipmentType;
            document.getElementById('start-datetime-text').textContent = report.start.timestamp ? report.start.timestamp.toLocaleString('pt-BR') : 'N/A';
            document.getElementById('end-datetime-text').textContent = report.end.timestamp ? report.end.timestamp.toLocaleString('pt-BR') : 'N/A';
            document.getElementById('distance-text').textContent = report.distance.toFixed(2) + ' km';
            document.getElementById('observations-text-display').textContent = report.observations || 'Nenhuma observa칞칚o registrada.';
            
            const materialsReportText = document.getElementById('materials-report-text');
            materialsReportText.innerHTML = '';
            if (report.materialsUsed.length > 0) {
                 report.materialsUsed.forEach(entry => {
                    const div = document.createElement('div');
                    div.innerHTML = `${entry.material} (${entry.type}): <span class="font-bold">${entry.quantity} ${entry.unit}</span>`;
                    materialsReportText.appendChild(div);
                });
            } else {
                materialsReportText.textContent = 'Nenhum material registrado.';
            }

            document.getElementById('start-location-text').textContent = report.start.location 
                ? `Lat: ${report.start.location.latitude.toFixed(4)}, Long: ${report.start.location.longitude.toFixed(4)}` 
                : 'Localiza칞칚o de In칤cio n칚o capturada.';
            document.getElementById('end-location-text').textContent = report.end.location 
                ? `Lat: ${report.end.location.latitude.toFixed(4)}, Long: ${report.end.location.longitude.toFixed(4)}` 
                : 'Localiza칞칚o de Fim n칚o capturada.';

            // Popula Preview de Fotos 
            document.getElementById('photos-report-preview-container').innerHTML = '';
            if (report.photoData.length > 0) {
                 report.photoData.forEach(base64Data => {
                    const img = document.createElement('img');
                    img.src = base64Data;
                    img.className = 'w-24 h-24 object-cover rounded-lg shadow-md';
                    document.getElementById('photos-report-preview-container').appendChild(img);
                });
            } else {
                 document.getElementById('photos-report-preview-container').textContent = 'Nenhuma foto capturada.';
            }

            document.getElementById('summary-text').textContent = report.aiSummary; 
            document.getElementById('summary-container').classList.remove('hidden');
            
            dataDisplay.classList.remove('hidden');
            document.getElementById('report-close-btn').classList.remove('hidden');

            showMessage(`Relat칩rio do servi칞o (${report.serviceStatus}) em exibi칞칚o. Clique em Encerrar para retornar.`, false);
        }

        // --- Material Logic ---
        function updateMaterialTypeOptions() {
            const materialName = materialSelect.value;
            const unitLabel = materialQuantityUnit;
            materialTypeSelect.innerHTML = '<option value="" disabled selected>Selecione o Tipo</option>';
            
            if (materialName && MATERIAL_DATA[materialName]) {
                const data = MATERIAL_DATA[materialName];
                unitLabel.textContent = data.unit;
                for (const type in data.types) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    materialTypeSelect.appendChild(option);
                }
            } else {
                unitLabel.textContent = "Unidade";
            }
        }

        function renderMaterialsList() {
            materialsList.innerHTML = '';
            if (appState.materialsUsed.length === 0) {
                materialsList.innerHTML = '<p id="no-materials-message" class="text-sm italic text-gray-600">Nenhum material adicionado.</p>';
                return;
            }

            appState.materialsUsed.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'material-entry';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${entry.material} (${entry.type})</span>
                    <span class="font-bold text-gray-700">${entry.quantity} ${entry.unit}</span>
                    <button data-index="${index}" class="remove-material-btn text-red-500 hover:text-red-700 font-bold ml-2">X</button>
                `;
                materialsList.appendChild(div);
            });

            document.querySelectorAll('.remove-material-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const indexToRemove = parseInt(this.dataset.index);
                    appState.materialsUsed.splice(indexToRemove, 1);
                    renderMaterialsList();
                    showMessage("Material removido.");
                });
            });
        }
        
        // --- Photo Capture Logic ---
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result;
                    appState.photoData.push(base64Data);
                    renderPhotoPreviews();
                    showMessage(`Foto capturada e adicionada (${appState.photoData.length} total).`);
                };
                reader.readAsDataURL(file);
                // Limpa o valor do input para permitir nova captura com a c칙mera
                event.target.value = null; 
            }
        }

        function renderPhotoPreviews() {
            photoPreviewContainer.innerHTML = '';
            if (appState.photoData.length === 0) return;

            appState.photoData.forEach((base64Data, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'relative';
                
                const img = document.createElement('img');
                img.src = base64Data;
                img.className = 'w-24 h-24 object-cover rounded-lg shadow-md';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'X';
                deleteBtn.className = 'absolute top-0 right-0 bg-red-600 text-white rounded-full w-5 h-5 text-xs font-bold -mt-1 -mr-1 hover:bg-red-700 transition-colors';
                deleteBtn.onclick = () => {
                    appState.photoData.splice(index, 1);
                    renderPhotoPreviews();
                    showMessage("Foto removida.");
                };

                imgContainer.appendChild(img);
                imgContainer.appendChild(deleteBtn);
                photoPreviewContainer.appendChild(imgContainer);
            });
        }

        // --- Event Listeners ---
        
        // Login - Check technician/employee login
        loginBtn.addEventListener('click', () => {
            const selectedCompany = companySelect.value;
            const selectedEmployee = employeeSelect.value;
            const inputPassword = passwordInput.value;
            
            if (loginData[selectedCompany] && loginData[selectedCompany][selectedEmployee] === inputPassword) {
                document.getElementById('logged-in-user').textContent = selectedEmployee;
                appState.loggedInCompany = selectedCompany; // Armazena a empresa
                appState.loggedInEmployee = selectedEmployee; // Armazena o funcion치rio
                
                // Esconde o login e mostra o app
                loginContainer.style.display = 'none'; 
                appContainer.style.display = 'block';
                resetAppState(); // Reseta o estado da OS, mas MANT칄M os dados de login.
            } else {
                showMessage("Login ou senha inv치lidos.", true);
            }
        });

        // Start Scan Button
        startScanBtn.addEventListener('click', () => {
            appState.scanMode = 'start';
            startScanner();
        });

        // Finish Scan Button
        finishScanBtn.addEventListener('click', () => {
            if (!appState.start.timestamp) {
                showMessage("Por favor, inicie o servi칞o primeiro.", true);
                return;
            }
            appState.scanMode = 'end';
            startScanner();
        });
        
        // Barcode Confirmation - SIM
        modalConfirmBarcodeBtn.addEventListener('click', continueScanProcess);

        // Barcode Confirmation - N츾O (Reinicia Scan)
        modalRescanBarcodeBtn.addEventListener('click', () => {
            barcodeConfirmationModal.style.display = 'none';
            // Garante que a UI esteja no modo de escaneamento antes de reiniciar
            startScanner(); 
        });

        // Finalize Service Button (Shows Modal)
        finalizeServiceBtn.addEventListener('click', () => {
             if (appState.scanMode !== 'end-done') { // Verifica se o scan de finaliza칞칚o foi feito
                showMessage("O escaneamento de finaliza칞칚o deve ser feito primeiro.", true);
                return;
            }
            finalizeServiceBtn.classList.add('hidden'); 
            document.getElementById('modal-os-number').textContent = appState.osNumber;
            document.getElementById('confirmation-modal').style.display = 'flex'; 
        });

        // Modal Confirmation: Finalizada
        document.getElementById('modal-finalize-btn').addEventListener('click', () => {
            document.getElementById('confirmation-modal').style.display = 'none';
            appState.serviceStatus = 'Finalizada';
            prepareReportData();
        });

        // Modal Confirmation: Interrompida
        document.getElementById('modal-interrupt-btn').addEventListener('click', () => {
            document.getElementById('confirmation-modal').style.display = 'none';
            appState.serviceStatus = 'Interrompida';
            prepareReportData();
        });

        // Manager Auth Button 
        document.getElementById('manager-auth-btn').addEventListener('click', () => {
            document.getElementById('manager-auth-modal').style.display = 'flex'; 
        });

        // Manager Login Button
        document.getElementById('manager-login-btn').addEventListener('click', () => {
            const selectedManager = document.getElementById('manager-select').value;
            const inputPassword = document.getElementById('manager-password-input').value;
            
            if (selectedManager === MANAGER_USERNAME && inputPassword === MANAGER_PASSWORD) {
                document.getElementById('manager-password-input').value = '';
                document.getElementById('manager-select').value = '';
                displayFinalReport(); 
            } else {
                showMessage("Nome do Gerente ou senha inv치lidos.", true);
            }
        });

        // Report CLOSE Button (Volta para o Login)
        document.getElementById('report-close-btn').addEventListener('click', () => {
            transitionToLoginUI();
        });
        
        // Material Event Listeners
        materialSelect.addEventListener('change', updateMaterialTypeOptions);
        addMaterialBtn.addEventListener('click', () => {
            const material = materialSelect.value;
            const quantity = parseFloat(materialQuantityInput.value.replace(',', '.')) || 0; 
            const type = materialTypeSelect.value;
            
            if (!material || quantity <= 0 || !type || !MATERIAL_DATA[material]) {
                showMessage("Preencha Material, Quantidade e Tipo de Material corretamente.", true);
                return;
            }
            
            const unit = MATERIAL_DATA[material].unit;
            const newEntry = { material, quantity, type, unit };
            appState.materialsUsed.push(newEntry);
            renderMaterialsList();
            
            // Reset form
            materialSelect.value = '';
            materialQuantityInput.value = '';
            updateMaterialTypeOptions('');
            showMessage(`Material ${material} (${type}, ${quantity} ${unit}) adicionado.`);
        });
        
        // Photo Capture Listeners 
        document.getElementById('take-photo-btn').addEventListener('click', () => {
            photoFileInput.click();
        });
        photoFileInput.addEventListener('change', handlePhotoCapture);


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
             // Initial login setup - Populating companies list 
             for (const company in loginData) {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            }
             companySelect.addEventListener('change', () => {
                const selectedCompany = companySelect.value;
                employeeSelect.innerHTML = '<option value="" disabled selected>Selecione um funcion치rio</option>';
                employeeSelect.disabled = false;
                if (selectedCompany && loginData[selectedCompany]) {
                    for (const employee in loginData[selectedCompany]) {
                        const option = document.createElement('option');
                        option.value = employee;
                        option.textContent = employee;
                        employeeSelect.appendChild(option);
                    }
                }
            });
            
            // Garante que a tela de login esteja vis칤vel ao carregar
            transitionToLoginUI(); 
            
        });
    </script>
</body>
</html>
