<!DOCTYPE html>
<html lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Serviço - Versão Simples</title>
    <script src="./Registro de Serviço - Versão Simples_files/saved_resource"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f5;
        }
        #reader {
            width: 100%;
            max-width: 400px;
            margin: auto;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px solid #a3b2b4;
            display: none;
        }
        .message-box {
            padding: 1rem;
            background-color: #d1e7e4;
            border-radius: 0.75rem;
            border: 1px solid #b7d6d1;
            margin-top: 1rem;
            display: none;
        }
        .data-display {
            background-color: #e6f0f2;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #c8d8e0;
            margin-top: 1.5rem;
        }
        .data-display div {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #a3b2b4;
        }
        .data-display div:last-child {
            border-bottom: none;
        }

        /* Estilo de Botão Padrão (Finalizada - Verde Escuro) */
        .button-primary {
            @apply text-white font-bold transition-all duration-300 ease-in-out;
            
            /* Cor base do botão (similar ao tom da imagem) */
            background-color: #00891d; 
            /* Gradiente para o efeito de brilho/gloss */
            background-image: linear-gradient(180deg, #00893d 0%, #00891d 100%);
            
            /* Borda arredondada completa (Pill Shape) */
            border-radius: 9999px; 
            
            /* Sombreamento suave por baixo */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2), 0 0 10px rgba(57, 211, 121, 0.4);
            border: none; /* Remove any default border */
        }
        .button-primary:hover {
            /* Escurece levemente no hover */
            background-color: #00891d;
            background-image: linear-gradient(180deg, #00893d 0%, #00891d 100%);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3), 0 0 12px rgba(57, 211, 121, 0.6);
        }
        .button-primary:active {
            /* Efeito de clique: reduz o tamanho e o brilho */
            transform: scale(0.98); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1), 0 0 5px rgba(57, 211, 121, 0.2);
            background-image: linear-gradient(180deg, #00893d 0%, #00891d 100%);
        }

        /* Botão secundário (Interrompida) - AGORA VERDE MAIS CLARO */
        .button-secondary {
            /* Usando um verde mais claro para indicar 'Interrompida' */
            @apply bg-green-300 text-green-800 shadow-sm hover:bg-green-400 transition-colors;
            border-radius: 9999px; 
        }

        .green-led {
            height: 12px;
            width: 12px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 5px #4CAF50, 0 0 10px #4CAF50;
        }
        
        /* Modal Overlay Styles */
        #confirmation-modal, #manager-auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-1{margin-left:0.25rem}.mr-2{margin-right:0.5rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.block{display:block}.flex{display:flex}.hidden{display:none}.min-h-screen{min-height:100vh}.w-full{width:100%}.max-w-sm{max-width:24rem}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.whitespace-pre-wrap{white-space:pre-wrap}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-green-300{--tw-border-opacity:1;border-color:rgb(134 239 172 / var(--tw-border-opacity, 1))}.bg-\[\#d1e7e4\]{--tw-bg-opacity:1;background-color:rgb(209 231 228 / var(--tw-bg-opacity, 1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.text-center{text-align:center}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.italic{font-style:italic}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61 / var(--tw-text-opacity, 1))}.text-red-800{--tw-text-opacity:1;color:rgb(153 27 27 / var(--tw-text-opacity, 1))}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition-shadow{transition-property:box-shadow;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-indigo-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(99 102 241 / var(--tw-ring-opacity, 1))}</style></head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">

    <div id="login-container" class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Login de Funcionário</h1>

        <div class="space-y-4">
            <div>
                <label for="company-select" class="block text-sm font-medium text-gray-700 mb-1">Empresa Terceirizada</label>
                <select id="company-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <option value="" disabled="" selected="">Selecione a empresa</option>
                    </select>
            </div>
            <div>
                <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-1">Nome do Funcionário</label>
                <select id="employee-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow" disabled="">
                    <option value="" disabled="" selected="">Selecione um funcionário</option>
                </select>
            </div>
            <div>
                <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input type="password" id="password-input" placeholder="Digite sua senha" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <button id="login-btn" class="w-full py-3 font-semibold text-lg button-primary">
                Entrar
            </button>
        </div>
        
        <div id="login-message-box" class="message-box" style="display:none;">
            <p id="login-message-text" class="text-sm font-medium text-gray-700"></p>
        </div>

    </div>

    <div id="app-container" class="bg-[#d1e7e4] rounded-xl shadow-lg p-6 max-w-sm w-full" style="display:none;">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Registro de Serviço</h1>
        
        <p class="text-center text-gray-600 mb-4">Bem-vindo(a), <span id="logged-in-user"></span>!</p>

        <div class="mb-4">
            <label for="os-number" class="block text-sm font-medium text-gray-700 mb-1">Número da Ordem de Serviço</label>
            <input type="text" id="os-number" placeholder="Digite a O.S." class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            
            <div id="service-active-status" class="mt-2 hidden items-center justify-between p-2 bg-green-100 border border-green-300 rounded-lg">
                <p class="text-sm font-semibold text-green-700 flex items-center">
                    <span class="green-led mr-2"></span>
                    O.S. <span id="os-text-active" class="ml-1 font-bold"></span> Ativa e em Andamento.
                </p>
            </div>
        </div>

        <div id="reader"></div>

        <div id="action-buttons" class="flex flex-col space-y-3">
            <button id="start-scan-btn" class="w-full py-3 font-semibold text-lg button-primary">
                Escanear para Iniciar
            </button>
            <button id="finish-scan-btn" class="w-full py-3 font-semibold text-lg button-primary" style="display:none;">
                Escanear para Finalizar
            </button>
        </div>

        <div id="observations-input-container" class="mt-4 hidden">
            <label for="observations-text" class="block text-sm font-medium text-gray-700 mb-1">Observações do Técnico</label>
            <textarea id="observations-text" placeholder="Descreva o serviço realizado, pendências, etc." rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow"></textarea>
        </div>
        
        <div id="lubrica-inputs-container" class="mt-4 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Reposição de Material</h3>
            <div class="space-y-4">
                <div>
                    <label for="material-select" class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                    <select id="material-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="" disabled="" selected="">Selecione o material</option>
                        <option value="oleo">Óleo</option>
                        <option value="graxa">Graxa</option>
                        <option value="parafina">Parafina</option>
                    </select>
                </div>
                <div>
                    <label for="quantity-input" class="block text-sm font-medium text-gray-700 mb-1">Quantidade (Litros/Kilos)</label>
                    <input type="number" id="quantity-input" min="1" placeholder="Digite a quantidade (Litros/Kilos)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                </div>
                <div>
                    <label for="type-select" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Material</label>
                    <select id="type-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow" disabled>
                        <option value="" disabled="" selected="">Selecione o tipo</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="photo-input-container" class="mt-4 hidden">
             <input type="file" id="photo-file-input" accept="image/*" capture="camera" class="hidden">
             <button id="take-photo-btn" class="w-full py-3 rounded-lg font-semibold text-lg button-secondary">
                Tirar Foto 📸
            </button>
            
            <div id="photo-preview-container" class="mt-3 flex flex-wrap gap-2">
                 </div>
        </div>
        
        <button id="finalize-service-btn" class="w-full py-3 font-bold text-lg button-primary mt-6 hidden">
            Finalizar Serviço
        </button>
        
        <div id="manager-check-container" class="data-display hidden text-center">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Acesso Gerencial</h2>
            <p class="text-gray-700 mb-4">Deseja checar a Ordem de Serviço finalizada/interrompida?</p>
            <button id="manager-auth-btn" class="py-3 px-6 font-semibold text-lg button-primary">
                OK
            </button>
        </div>


        <div id="message-box" class="message-box" style="display:none;">
            <p id="message-text" class="text-sm font-medium text-gray-700"></p>
        </div>

        <div id="data-display" class="data-display hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Relatório de Serviço</h2>
            <div id="os-display">
                <span class="font-semibold text-gray-600">O.S.:</span> <span id="os-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="status-display">
                <span class="font-semibold text-gray-600">Status:</span> <span id="service-status-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="barcode-display">
                <span class="font-semibold text-gray-600">Cód. de Barras:</span> <span id="barcode-text" class="font-medium text-gray-800"></span>
            </div>
             <div id="equipment-type-display">
                <span class="font-semibold text-gray-600">Tipo de Equipamento:</span> <span id="equipment-type-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="start-data-display">
                <span class="font-semibold text-gray-600">Início:</span> <span id="start-datetime-text" class="font-medium text-gray-800"></span>
            </div>
            <div>
                <span class="font-semibold text-gray-600">Localização Início:</span> <span id="start-location-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="end-data-display">
                <span class="font-semibold text-gray-600">Fim:</span> <span id="end-datetime-text" class="font-medium text-gray-800"></span>
            </div>
            <div>
                <span class="font-semibold text-gray-600">Localização Fim:</span> <span id="end-location-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="distance-display">
                <span class="font-semibold text-gray-600">Distância Percorrida:</span> <span id="distance-text" class="font-medium text-gray-800"></span>
            </div>
            <div id="observations-display">
                <span class="font-semibold text-gray-600">Observações:</span> <span id="observations-text-display" class="font-medium text-gray-800 whitespace-pre-wrap"></span>
            </div>
             <div id="photos-report-display">
                <span class="font-semibold text-gray-600">Fotos Capturadas:</span>
                <div id="photos-report-preview-container" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </div>
        
        <div id="summary-container" class="data-display hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Resumo do Serviço (IA)</h2>
            <p id="summary-text" class="text-gray-700 text-sm italic">Resumo de IA desativado conforme solicitado.</p>
        </div>
        
        <button id="report-close-btn" class="w-full py-3 font-bold text-lg button-primary mt-6 hidden">
            Encerrar (Voltar ao Início)
        </button>

    </div>
    
    <div id="confirmation-modal">
        <div id="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Confirmação de Serviço</h3>
            <p class="mb-4 text-gray-600">O serviço na O.S. <span id="modal-os-number" class="font-bold"></span> foi:</p>
            <div class="flex flex-col space-y-3">
                <button id="modal-finalize-btn" class="py-3 font-semibold text-lg button-primary">
                    Finalizada
                </button>
                <button id="modal-interrupt-btn" class="py-3 rounded-lg font-semibold text-lg button-secondary">
                    Interrompida
                </button>
            </div>
        </div>
    </div>
    
    <div id="manager-auth-modal">
        <div id="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Autenticação Gerencial</h3>
            <p class="mb-4 text-gray-600">Para visualizar o relatório, o Gerente deve se autenticar.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="manager-select" class="block text-sm font-medium text-gray-700 mb-1">Nome do Gerente</label>
                    <select id="manager-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="" disabled="" selected="">Selecione o Gerente</option>
                        <option value="Gerente">Gerente</option>
                    </select>
                </div>
                <div>
                    <label for="manager-password-input" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="manager-password-input" placeholder="Digite sua senha" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                </div>
                <button id="manager-login-btn" class="w-full py-3 font-semibold text-lg button-primary">
                    Acessar Relatório
                </button>
            </div>

             <div id="manager-message-box" class="message-box mt-3" style="display:none; background-color: #fca5a5; border-color: #ef4444;">
                <p id="manager-message-text" class="text-sm font-medium text-red-800"></p>
            </div>
        </div>
    </div>


    <script src="./Registro de Serviço - Versão Simples_files/html5-qrcode.min.js.baixados"></script>

    <script>
        // Main application state and data container
        const appState = {
            osNumber: '',
            barcodeData: '',
            equipmentType: '',
            inventoryNumber: '',
            observations: '',
            photoData: [], // Array to hold multiple photo Base64 strings
            serviceStatus: '',
            start: {
                timestamp: null,
                location: null,
            },
            end: {
                timestamp: null,
                location: null,
            },
            scanMode: 'start',
            isServiceActive: false, // Flag to track active service state
            // Data persisted after finalization, used for Manager view
            finalReportData: null, 
            
            // NEW Lubrica-specific fields
            material: '', 
            quantity: 0,
            materialType: '',
        };

        // Mock data for login (Funcionário: '123', Gerente: '111')
        const loginData = {
            "Arcondi": { 
                "Abc": "123", 
                "Def": "123", 
                "Ghi": "123",
                "Gerente": "123" // Usuário Gerente
            },
            "Lubrica": { 
                "Jk": "123", 
                "Lm": "123", 
                "No": "123" 
            }
        };
        const MANAGER_USERNAME = "Gerente";
        const MANAGER_PASSWORD = "123";

        // Vetores de Alerta para Gerente (Material e Quantidade Máxima)
        const MAX_QUANTITIES = {
            oleo: { type: ['32', '46'], max: [1, 1], unit: 'litros' }, 
            graxa: { type: ['A', 'B'], max: [1, 1], unit: 'kilos' },     
            parafina: { type: ['branca', 'translucida'], max: [1, 1], unit: 'litros' } 
        };

        // DOM element references
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const companySelect = document.getElementById('company-select');
        const employeeSelect = document.getElementById('employee-select');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const loggedInUserText = document.getElementById('logged-in-user');

        const osInput = document.getElementById('os-number');
        const osTextActive = document.getElementById('os-text-active');
        const startScanBtn = document.getElementById('start-scan-btn');
        const finishScanBtn = document.getElementById('finish-scan-btn');
        const finalizeServiceBtn = document.getElementById('finalize-service-btn');
        const reportCloseBtn = document.getElementById('report-close-btn');

        const readerDiv = document.getElementById('reader');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const dataDisplay = document.getElementById('data-display');
        const serviceActiveStatus = document.getElementById('service-active-status');
        const managerCheckContainer = document.getElementById('manager-check-container'); 
        const managerAuthBtn = document.getElementById('manager-auth-btn'); 

        // NEW DOM References for Lubrica inputs
        const lubricaInputsContainer = document.getElementById('lubrica-inputs-container');
        const materialSelect = document.getElementById('material-select');
        const quantityInput = document.getElementById('quantity-input');
        const typeSelect = document.getElementById('type-select');
        
        // Modals
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalOsNumber = document.getElementById('modal-os-number');
        const modalFinalizeBtn = document.getElementById('modal-finalize-btn');
        const modalInterruptBtn = document.getElementById('modal-interrupt-btn');
        
        // Manager Auth Modal elements
        const managerAuthModal = document.getElementById('manager-auth-modal');
        const managerSelect = document.getElementById('manager-select');
        const managerPasswordInput = document.getElementById('manager-password-input');
        const managerLoginBtn = document.getElementById('manager-login-btn');
        const managerMessageBox = document.getElementById('manager-message-box');
        const managerMessageText = document.getElementById('manager-message-text');


        // Report display elements (simplified names for brevity)
        const observationsTextArea = document.getElementById('observations-text');
        const observationsInputContainer = document.getElementById('observations-input-container');
        const photoInputContainer = document.getElementById('photo-input-container');
        const photoFileInput = document.getElementById('photo-file-input');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const summaryContainer = document.getElementById('summary-container');
        
        let html5QrCode;

        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.style.display = 'block';
            if (isError) {
                messageBox.classList.remove('bg-gray-200', 'bg-[#d1e7e4]');
                messageBox.classList.add('bg-red-200');
            } else {
                messageBox.classList.remove('bg-red-200');
                messageBox.classList.add('bg-gray-200', 'bg-[#d1e7e4]');
            }
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }
        
        function showManagerMessage(text) {
             managerMessageText.textContent = text;
             managerMessageBox.style.display = 'block';
             setTimeout(() => {
                managerMessageBox.style.display = 'none';
            }, 5000);
        }

        // --- Core Reset Function ---
        function resetAppState() {
            // Reset app state
            appState.osNumber = '';
            appState.barcodeData = '';
            appState.equipmentType = '';
            appState.inventoryNumber = '';
            appState.observations = '';
            appState.photoData = [];
            appState.serviceStatus = '';
            appState.start.timestamp = null;
            appState.start.location = null;
            appState.end.timestamp = null;
            appState.end.location = null;
            appState.scanMode = 'start';
            appState.finalReportData = null;
            appState.isServiceActive = false; // Reset active flag
            
            // Reset NEW Lubrica fields
            appState.material = '';
            appState.quantity = 0;
            appState.materialType = '';
            materialSelect.value = '';
            quantityInput.value = '';
            typeSelect.innerHTML = '<option value="" disabled="" selected="">Selecione o tipo</option>';
            typeSelect.disabled = true;
            
            // Reset input/preview fields
            osInput.value = '';
            observationsTextArea.value = '';
            photoPreviewContainer.innerHTML = '';
            
            // Hide all post-service/active elements
            dataDisplay.classList.add('hidden');
            summaryContainer.classList.add('hidden');
            reportCloseBtn.classList.add('hidden');
            serviceActiveStatus.classList.add('hidden');
            observationsInputContainer.classList.add('hidden');
            photoInputContainer.classList.add('hidden');
            lubricaInputsContainer.classList.add('hidden'); // Hide Lubrica container
            finishScanBtn.style.display = 'none';
            finalizeServiceBtn.classList.add('hidden'); // Ensure finalize is hidden initially
            managerCheckContainer.classList.add('hidden'); 
            managerAuthModal.style.display = 'none'; 
            
            // Show initial input/button
            osInput.disabled = false;
            osInput.style.display = 'block';
            startScanBtn.style.display = 'block';

            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            
            showMessage("Pronto para uma nova Ordem de Serviço!");
        }

        function transitionToActiveServiceUI() {
            // Technician Active Phase (After Start Scan or failure return)
            appState.isServiceActive = true;

            osInput.disabled = true;
            osInput.style.display = 'none'; // Hide input when active
            startScanBtn.style.display = 'none';

            osTextActive.textContent = appState.osNumber;
            serviceActiveStatus.classList.remove('hidden');
            finishScanBtn.style.display = 'block'; // Show end scan button
            observationsInputContainer.classList.remove('hidden');
            photoInputContainer.classList.remove('hidden'); 
            
            // NEW: Show Lubrica inputs only for 'Lubrica' company
            const selectedCompany = companySelect.value;
            if (selectedCompany === 'Lubrica') {
                 lubricaInputsContainer.classList.remove('hidden');
            } else {
                 lubricaInputsContainer.classList.add('hidden');
            }
            
            finalizeServiceBtn.classList.add('hidden'); // Ensure finalize is hidden until end scan
            finalizeServiceBtn.disabled = true;
        }
        
        function transitionToManagerCheckUI() {
            // Technician Phase -> Manager Check Phase
            serviceActiveStatus.classList.add('hidden');
            finishScanBtn.style.display = 'none';
            finalizeServiceBtn.classList.add('hidden');
            observationsInputContainer.classList.add('hidden');
            photoInputContainer.classList.add('hidden');
            lubricaInputsContainer.classList.add('hidden'); // Hide Lubrica inputs

            managerCheckContainer.classList.remove('hidden');
            showMessage("Serviço finalizado. Aguardando conferência do Gerente.");
        }

        async function startScanner() {
            try {
                // Check for OS before scan
                const os = osInput.value.trim();
                if (appState.scanMode === 'start' && !os) {
                    showMessage("Por favor, digite o número da O.S. antes de escanear.", true);
                    return;
                }
                if (appState.scanMode === 'start') {
                    appState.osNumber = os;
                }

                readerDiv.style.display = 'block';
                // Hide active UI during scan
                serviceActiveStatus.classList.add('hidden');
                finishScanBtn.style.display = 'none';
                finalizeServiceBtn.classList.add('hidden'); 
                observationsInputContainer.classList.add('hidden');
                photoInputContainer.classList.add('hidden');
                lubricaInputsContainer.classList.add('hidden'); // Hide Lubrica inputs during scan
                startScanBtn.style.display = 'none';

                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    formatsToSupport: [Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.QR_CODE],
                };
                const constraints = { facingMode: { exact: "environment" } };

                html5QrCode = new Html5Qrcode("reader");

                await html5QrCode.start( constraints, config,
                    (decodedText, decodedResult) => {
                        html5QrCode.stop().then(() => {
                            readerDiv.style.display = 'none';
                            if (appState.scanMode === 'start') {
                                handleStartScanSuccess(decodedText);
                            } else {
                                handleFinishScanSuccess();
                            }
                        }).catch(err => {
                            console.error("Error stopping scanner:", err);
                            showMessage("Erro ao parar o scanner.", true);
                            resetUIScannerFail();
                        });
                    },
                    (errorMessage) => { /* Ignore continuous error messages */ }
                );
            } catch (err) {
                console.error("Erro ao iniciar o scanner:", err);
                // Melhorando a mensagem de erro para o usuário
                showMessage(`Erro ao iniciar a câmera ou valor de restrição não suportado. Verifique as permissões da câmera. Erro: ${err.message}`, true);
                readerDiv.style.display = 'none';
                resetUIScannerFail();
            }
        }

        function resetUIScannerFail() {
            // Reverte a UI se o scanner falhar
            if (appState.isServiceActive) {
                // Verifica se já estamos no estado pós-escaneamento de fim (onde o botão de Finalizar deveria estar visível)
                if (appState.end.timestamp) {
                    // Restaura a UI para mostrar o botão Finalizar
                    serviceActiveStatus.classList.remove('hidden'); 
                    observationsInputContainer.classList.remove('hidden');
                    photoInputContainer.classList.remove('hidden');
                    if (companySelect.value === 'Lubrica') lubricaInputsContainer.classList.remove('hidden'); // Restore Lubrica inputs
                    finalizeServiceBtn.classList.remove('hidden'); // AQUI é onde o botão Finalizar é restaurado
                    finalizeServiceBtn.disabled = false;
                    finishScanBtn.style.display = 'none'; 
                    showMessage("Falha no scanner. O.S. pronta para Finalizar Serviço.");
                } else {
                    // Restaura a UI para o estado ativo (aguardando escaneamento de fim)
                    transitionToActiveServiceUI(); 
                    showMessage("Falha no scanner. Por favor, tente escanear novamente para finalizar.", true);
                }
            } else {
                // Restaura a UI para o estado inicial (pré-escaneamento de início)
                osInput.style.display = 'block';
                osInput.disabled = false;
                startScanBtn.style.display = 'block';
            }
        }
        
        function handleStartScanSuccess(decodedText) {
            showMessage("Código de barras escaneado com sucesso! Serviço Iniciado.");
            
            // Simulação de parse de dados de equipamento
            const equipmentType = decodedText.charAt(0).toUpperCase();
            const inventoryNumber = decodedText.substring(1);

            appState.barcodeData = decodedText;
            appState.equipmentType = equipmentType;
            appState.inventoryNumber = inventoryNumber;

            appState.start.timestamp = new Date();
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = position.coords;
                        appState.start.location = { latitude: coords.latitude, longitude: coords.longitude, accuracy: coords.accuracy };
                        showMessage("Localização de início obtida com sucesso!");
                    },
                    (error) => {
                        console.error("Geolocation error (start):", error);
                        showMessage("Não foi possível obter a localização de início.", true);
                    }
                );
            } else {
                showMessage("Seu navegador não suporta geolocalização.", true);
            }
            transitionToActiveServiceUI();
        }

        function handleFinishScanSuccess() {
            showMessage("Escaneamento de Finalização concluído. Pronto para Finalizar Serviço.");
            
            // 1. Capture end timestamp immediately 
            appState.end.timestamp = new Date();
            
            // 2. Restore active UI and ENABLE Finalize button
            serviceActiveStatus.classList.remove('hidden'); 
            observationsInputContainer.classList.remove('hidden');
            photoInputContainer.classList.remove('hidden');
            if (companySelect.value === 'Lubrica') lubricaInputsContainer.classList.remove('hidden'); // Restore Lubrica inputs
            
            // ENABLE Finalize button
            finalizeServiceBtn.classList.remove('hidden'); 
            finalizeServiceBtn.disabled = false; 
            finishScanBtn.style.display = 'none'; 

            // 3. Get end location (runs asynchronously but doesn't block button)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = position.coords;
                        appState.end.location = { latitude: coords.latitude, longitude: coords.longitude, accuracy: coords.accuracy };
                    },
                    (error) => {
                        console.error("Geolocation error (end):", error);
                        showMessage("Localização de encerramento não capturada.", true);
                    }
                );
            }
        }

        // Haversine formula
        function calculateDistance(start, end) {
             if (!start || !end) return 0;
            const R = 6371;
            const lat1 = start.latitude;
            const lon1 = start.longitude;
            const lat2 = end.latitude;
            const lon2 = end.longitude;
            const toRadians = (deg) => deg * (Math.PI / 180);
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        // --- Report Generation and Display ---
        async function prepareReportData() {
            // Step 1: Save technician inputs to a final data structure
            appState.observations = observationsTextArea.value.trim();
            const distanceKm = calculateDistance(appState.start.location, appState.end.location);
            
            // CAPTURA DOS NOVOS CAMPOS
            appState.material = materialSelect.value;
            appState.quantity = parseFloat(quantityInput.value) || 0;
            appState.materialType = typeSelect.value;
            
            // CHECAGEM DE EXCESSO
            let alertMessage = null;
            const isLubrica = companySelect.value === 'Lubrica';
            
            if (isLubrica && appState.material && appState.materialType && appState.quantity > 0) {
                 const materialKey = appState.material;
                 const materialInfo = MAX_QUANTITIES[materialKey];
                 const typeIndex = materialInfo.type.map(t => t.toLowerCase().replace(' ', '')).findIndex(t => t === appState.materialType);
                 
                 if (typeIndex !== -1) {
                     const max = materialInfo.max[typeIndex];
                     const unit = materialInfo.unit;
                     const typeText = materialInfo.type[typeIndex]; // The non-slugified text
                     
                     if (appState.quantity > max) {
                         const exceededBy = appState.quantity - max;
                         alertMessage = `[ALERTA DE EXCESSO] Reposição Excedida! O.S.: ${appState.osNumber}, Material: ${materialKey.toUpperCase()}, Tipo: ${typeText}, Quantidade: ${appState.quantity} ${unit} (Excesso de ${exceededBy.toFixed(2)} ${unit}). Gerente, Avaliar Urgente possíveis danos/vazamentos.`;
                     }
                 }
            }


            const report = {
                osNumber: appState.osNumber,
                serviceStatus: appState.serviceStatus,
                barcodeData: appState.barcodeData,
                equipmentType: appState.equipmentType,
                start: {
                    timestamp: appState.start.timestamp,
                    location: appState.start.location,
                },
                end: {
                    timestamp: appState.end.timestamp,
                    location: appState.end.location,
                },
                distance: distanceKm,
                observations: appState.observations,
                photoData: [...appState.photoData], 
                
                // NOVOS CAMPOS NO RELATÓRIO
                material: appState.material ? `${materialSelect.options[materialSelect.selectedIndex].textContent}` : 'N/A',
                materialType: appState.materialType ? `${typeSelect.options[typeSelect.selectedIndex].textContent}` : 'N/A',
                quantity: appState.quantity > 0 ? `${appState.quantity} ${MAX_QUANTITIES[appState.material]?.unit || ''}` : 'N/A',

                // NOVO CAMPO DE ALERTA
                managerAlert: alertMessage, 
            };

            // Step 2: AI Summary is disabled
            report.aiSummary = 'Resumo de IA desativado conforme solicitado.';

            // Save for Manager View
            appState.finalReportData = report;

            transitionToManagerCheckUI();
        }

        function displayFinalReport() {
            if (!appState.finalReportData) {
                showMessage("Erro: Nenhum dado de relatório para exibir.", true);
                return;
            }

            const report = appState.finalReportData;
            
            // Hide Manager Check and Auth Modal
            document.getElementById('manager-check-container').classList.add('hidden');
            document.getElementById('manager-auth-modal').style.display = 'none';
            
            // Remove previous dynamic report elements (especially the alert div)
            const oldAlert = document.getElementById('manager-alert-display');
            if (oldAlert) oldAlert.remove();
            const oldMaterial = document.getElementById('material-report-display');
            if (oldMaterial) oldMaterial.remove();
            const oldQuantity = document.getElementById('quantity-report-display');
            if (oldQuantity) oldQuantity.remove();

            // Populate Report (use specific IDs)
            document.getElementById('os-text').textContent = report.osNumber;
            document.getElementById('service-status-text').textContent = report.serviceStatus;
            document.getElementById('barcode-text').textContent = report.barcodeData;
            document.getElementById('equipment-type-text').textContent = report.equipmentType;
            document.getElementById('start-datetime-text').textContent = report.start.timestamp ? report.start.timestamp.toLocaleString('pt-BR') : 'N/A';
            document.getElementById('end-datetime-text').textContent = report.end.timestamp ? report.end.timestamp.toLocaleString('pt-BR') : 'N/A';
            document.getElementById('distance-text').textContent = report.distance.toFixed(2) + ' km';
            document.getElementById('observations-text-display').textContent = report.observations || 'Nenhuma observação registrada.';
            
            // Set location text 
            document.getElementById('start-location-text').textContent = report.start.location 
                ? `Lat: ${report.start.location.latitude.toFixed(4)}, Long: ${report.start.location.longitude.toFixed(4)}` 
                : 'Localização de Início não capturada.';
            document.getElementById('end-location-text').textContent = report.end.location 
                ? `Lat: ${report.end.location.latitude.toFixed(4)}, Long: ${report.end.location.longitude.toFixed(4)}` 
                : 'Localização de Fim não capturada.';

            
            // --- NEW: Display Material, Quantity, and Alert ---
            const statusDisplay = document.getElementById('status-display');
            const equipmentTypeDisplay = document.getElementById('equipment-type-display');

            // 1. Alerta de Gerente
            const managerAlertDiv = document.createElement('div');
            managerAlertDiv.id = 'manager-alert-display';
            managerAlertDiv.style.borderBottom = '1px dashed #a3b2b4';
            
            const alertTextContent = document.createElement('span');
            alertTextContent.id = 'alert-text';

            if (report.managerAlert) {
                managerAlertDiv.innerHTML = `<span class="font-semibold text-gray-600">⚠ ALERTA DE REPOSIÇÃO:</span>`;
                alertTextContent.textContent = report.managerAlert;
                alertTextContent.className = 'font-bold text-red-800 block mt-1';
                managerAlertDiv.style.backgroundColor = '#fca5a5'; // Fundo vermelho claro
                managerAlertDiv.style.borderRadius = '0.5rem';
                managerAlertDiv.style.padding = '0.75rem';
                managerAlertDiv.style.border = '1px solid #ef4444';
            } else {
                 managerAlertDiv.innerHTML = `<span class="font-semibold text-gray-600">Alerta de Reposição:</span>`;
                 alertTextContent.textContent = 'Nenhum alerta de excesso.';
                 alertTextContent.className = 'font-medium text-gray-800 block mt-1';
                 managerAlertDiv.style.backgroundColor = 'transparent';
                 managerAlertDiv.style.borderRadius = '0';
                 managerAlertDiv.style.padding = '0.5rem 0';
                 managerAlertDiv.style.border = 'none';
            }
            managerAlertDiv.appendChild(alertTextContent);
            statusDisplay.parentNode.insertBefore(managerAlertDiv, statusDisplay.nextSibling); 

            // 2. Material Reposto (Óleo/Graxa/Parafina)
            const materialDisplay = document.createElement('div');
            materialDisplay.id = 'material-report-display';
            materialDisplay.innerHTML = `<span class="font-semibold text-gray-600">Material Reposto:</span> <span class="font-medium text-gray-800">${report.material} (${report.materialType})</span>`;
            equipmentTypeDisplay.parentNode.insertBefore(materialDisplay, equipmentTypeDisplay.nextSibling);

            // 3. Quantidade
            const quantityDisplay = document.createElement('div');
            quantityDisplay.id = 'quantity-report-display';
            quantityDisplay.innerHTML = `<span class="font-semibold text-gray-600">Quantidade:</span> <span class="font-medium text-gray-800">${report.quantity}</span>`;
            materialDisplay.parentNode.insertBefore(quantityDisplay, materialDisplay.nextSibling);
            // --- END NEW DISPLAY ---
            
            // Populate Photo Report Preview
            document.getElementById('photos-report-preview-container').innerHTML = '';
            if (report.photoData.length > 0) {
                 report.photoData.forEach(base64Data => {
                    const img = document.createElement('img');
                    img.src = base64Data;
                    img.className = 'w-24 h-24 object-cover rounded-lg shadow-md';
                    document.getElementById('photos-report-preview-container').appendChild(img);
                });
            } else {
                 document.getElementById('photos-report-preview-container').textContent = 'Nenhuma foto capturada.';
            }

            // Show Summary (Inativa, apenas exibe a mensagem)
            document.getElementById('summary-text').textContent = report.aiSummary; 
            document.getElementById('summary-container').classList.remove('hidden');
            
            // Show the report and CLOSE button
            document.getElementById('data-display').classList.remove('hidden');
            document.getElementById('report-close-btn').classList.remove('hidden');

            showMessage(`Relatório do serviço (${report.serviceStatus}) em exibição. Clique em Encerrar para retornar.`, false);
        }

        // --- Photo Capture Functions ---
        document.getElementById('take-photo-btn').addEventListener('click', () => { photoFileInput.click(); });

        photoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result;
                    appState.photoData.push(base64Data);
                    
                    const img = document.createElement('img');
                    img.src = base64Data;
                    img.alt = `Foto ${appState.photoData.length}`;
                    img.className = 'w-20 h-20 object-cover rounded-lg shadow-md';
                    photoPreviewContainer.appendChild(img);
                    
                    showMessage(`Foto ${appState.photoData.length} capturada com sucesso!`);
                };
                reader.readAsDataURL(file);
            }
            photoFileInput.value = '';
        });


        // --- Event Listeners for the Main App ---
        
        // Login - Check technician/employee login
        document.getElementById('login-btn').addEventListener('click', () => {
            const selectedCompany = companySelect.value;
            const selectedEmployee = employeeSelect.value;
            const inputPassword = passwordInput.value;
            
            if (loginData[selectedCompany] && loginData[selectedCompany][selectedEmployee] === inputPassword) {
                document.getElementById('logged-in-user').textContent = selectedEmployee;
                resetAppState();
            } else {
                showMessage("Login ou senha inválidos.", true);
            }
        });

        // Start Scan Button (Directly calls scanner after OS check)
        startScanBtn.addEventListener('click', () => {
            appState.scanMode = 'start';
            startScanner();
        });

        // Finish Scan Button (Starts barcode scan for end)
        finishScanBtn.addEventListener('click', () => {
            if (!appState.start.timestamp) {
                showMessage("Por favor, inicie o serviço primeiro.", true);
                return;
            }
            appState.scanMode = 'end';
            startScanner();
        });
        
        // Finalize Service Button (Shows Finalization/Interruption Modal)
        finalizeServiceBtn.addEventListener('click', () => {
             if (!appState.end.timestamp) {
                showMessage("O escaneamento de finalização deve ser feito primeiro.", true);
                return;
            }
            modalOsNumber.textContent = appState.osNumber;
            confirmationModal.style.display = 'flex'; // Abre o modal de finalização/interrupção
        });

        // Modal Confirmation: Finalizada
        modalFinalizeBtn.addEventListener('click', () => {
            appState.serviceStatus = 'Finalizada';
            confirmationModal.style.display = 'none';
            prepareReportData(); 
        });

        // Modal Confirmation: Interrompida
        modalInterruptBtn.addEventListener('click', () => {
            appState.serviceStatus = 'Interrompida';
            confirmationModal.style.display = 'none';
            prepareReportData(); 
        });
        
        // NEW: Lógica de dependência para o dropdown de Tipo de Material
        materialSelect.addEventListener('change', (event) => {
            const selectedMaterial = event.target.value;
            typeSelect.innerHTML = '<option value="" disabled="" selected="">Selecione o tipo</option>';
            typeSelect.disabled = true;
            
            if (selectedMaterial && MAX_QUANTITIES[selectedMaterial]) {
                const materialInfo = MAX_QUANTITIES[selectedMaterial];
                materialInfo.type.forEach(typeText => {
                    const option = document.createElement('option');
                    // Use um valor 'slugified' (sem espaços/maiusculas) para a checagem, mas mantenha o texto legível
                    option.value = typeText.toLowerCase().replace(' ', ''); 
                    
                    let display = typeText;
                    if (selectedMaterial === 'oleo') display = `Óleo ${typeText}`;
                    if (selectedMaterial === 'graxa') display = `Graxa ${typeText}`;
                    
                    option.textContent = display;
                    typeSelect.appendChild(option);
                });
                typeSelect.disabled = false;
            }
        });


        // Manager Auth Button (Shows Auth Modal)
        managerAuthBtn.addEventListener('click', () => {
            managerAuthModal.style.display = 'flex'; 
        });

        // Manager Login Button (Checks Auth and Shows Report)
        managerLoginBtn.addEventListener('click', () => {
            const selectedManager = managerSelect.value;
            const inputPassword = managerPasswordInput.value;
            
            if (selectedManager === MANAGER_USERNAME && inputPassword === MANAGER_PASSWORD) {
                managerPasswordInput.value = '';
                managerSelect.value = '';
                displayFinalReport(); 
            } else {
                showManagerMessage("Nome do Gerente ou senha inválidos.", true);
            }
        });

        // Report CLOSE Button (Resets flow)
        document.getElementById('report-close-btn').addEventListener('click', () => {
            resetAppState();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
             // Initial login setup
             for (const company in loginData) {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            }
             companySelect.addEventListener('change', () => {
                const selectedCompany = companySelect.value;
                employeeSelect.innerHTML = '<option value="" disabled selected>Selecione um funcionário</option>';
                employeeSelect.disabled = false;
                if (selectedCompany && loginData[selectedCompany]) {
                    for (const employee in loginData[selectedCompany]) {
                        const option = document.createElement('option');
                        option.value = employee;
                        option.textContent = employee;
                        employeeSelect.appendChild(option);
                    }
                }
            });
            
        });
    </script>
</body></html>
